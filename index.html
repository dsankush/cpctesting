<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Coromandel CPC — Campaign Dashboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700;800;900&family=Space+Grotesk:wght@500;600;700;800;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

  <style>
    :root{
      --bg:#f8fafc;
      --panel:#ffffff;
      --card:#ffffff;
      --card-hover:#f8f9ff;
      --muted:#6b7280;
      --text:#1f2937;
      --acc1:#6366f1;
      --acc2:#f59e0b;
      --acc3:#10b981;
      --acc4:#ec4899;
      --acc5:#8b5cf6;
      --ring:#e5e7eb;
      --border:#d1d5db;
      --shadow:rgba(99,102,241,.08);
      --shadow-lg:rgba(99,102,241,.15);
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%;overflow-x:hidden}
    body{
      font-family:'Outfit',sans-serif;
      background:var(--bg);
      color:var(--text);
    }
    .app{display:grid;grid-template-rows:auto 1fr auto;min-height:100vh}
    
    /* Header */
    header{
      position:sticky;top:0;z-index:30;
      backdrop-filter:saturate(180%) blur(20px);
      background:rgba(255,255,255,.98);
      border-bottom:2px solid var(--ring);
      box-shadow:0 4px 16px var(--shadow);
    }
    .bar{display:flex;align-items:center;gap:20px;padding:20px 40px;flex-wrap:wrap;position:relative}
    .hidden-theme-btn{
      position:absolute;
      top:10px;
      left:10px;
      width:40px;
      height:40px;
      background:transparent;
      border:none;
      cursor:pointer;
      opacity:0;
      z-index:999;
      transition:opacity 0.3s ease;
      display:none;
    }
    .hidden-theme-btn:hover{
      opacity:0.1;
      background:linear-gradient(135deg,var(--acc1),var(--acc4));
      border-radius:8px;
    }
    .logo{
      display:flex;align-items:center;gap:16px;
      padding:14px 28px;
      border-radius:16px;
      background:rgba(255,255,255,0.5);
      backdrop-filter:blur(10px);
      box-shadow:0 4px 16px rgba(99,102,241,0.2);
      border:2px solid rgba(99,102,241,0.1);
    }
    .dot{
      width:20px;height:20px;border-radius:50%;
      background:linear-gradient(135deg,var(--acc1),var(--acc4));
      box-shadow:0 4px 12px rgba(99,102,241,0.4);
      animation:pulseGlow 2s ease-in-out infinite;
    }
    @keyframes pulseGlow{
      0%,100%{transform:scale(1);opacity:1}
      50%{transform:scale(1.15);opacity:.8}
    }
    .title{
      font-size:1.8rem;
      margin:0;
      color:var(--text);
      letter-spacing:0.5px;
      font-weight:900;
      font-family:'Space Grotesk',sans-serif;
      background:linear-gradient(135deg,var(--acc1),var(--acc4));
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      background-clip:text;
    }
    .header-actions{margin-left:auto;display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .btn{
      display:inline-flex;align-items:center;justify-content:center;gap:8px;
      padding:12px 24px;border-radius:12px;border:none;
      background:linear-gradient(135deg,var(--acc1),var(--acc5));
      color:white;font-weight:700;cursor:pointer;font-size:14px;
      transition:all .3s ease;white-space:nowrap;
      box-shadow:0 4px 12px rgba(99,102,241,.25);
    }
    .btn:hover{
      transform:translateY(-2px);
      box-shadow:0 8px 24px rgba(99,102,241,.4);
    }
    .btn-logout{
      background:linear-gradient(135deg,#ef4444,#dc2626);
      box-shadow:0 4px 12px rgba(239,68,68,.25);
    }
    .btn-logout:hover{
      box-shadow:0 8px 24px rgba(239,68,68,.4);
    }

    /* Layout */
    .main{display:flex;flex-direction:column;gap:28px;padding:32px 40px;max-width:100%;margin:0}
    
    /* Filters - Modern Advanced Design */
    .filters-horizontal{
      background:linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(249,250,251,0.98) 100%);
      backdrop-filter:blur(20px);
      border:2px solid rgba(255,255,255,0.8);
      border-radius:24px;
      padding:32px;
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
      gap:24px;
      align-items:end;
      box-shadow:0 8px 32px rgba(0,0,0,0.08), 0 2px 8px rgba(0,0,0,0.04), inset 0 1px 0 rgba(255,255,255,0.9);
      position:relative;
      overflow:hidden;
      transition:all .4s cubic-bezier(0.4,0,0.2,1);
    }
    .filters-horizontal::before{
      content:'';
      position:absolute;
      top:0;left:0;right:0;
      height:3px;
      background:linear-gradient(90deg, #6366f1, #ec4899, #10b981, #f59e0b, #6366f1);
      background-size:200% 100%;
      animation:shimmer 3s linear infinite;
    }
    @keyframes shimmer{
      0%{background-position:200% 0}
      100%{background-position:-200% 0}
    }
    .filters-horizontal:hover{
      box-shadow:0 12px 48px rgba(0,0,0,0.12), 0 4px 16px rgba(0,0,0,0.06), inset 0 1px 0 rgba(255,255,255,1);
      transform:translateY(-2px);
    }
    .filters-horizontal .group{
      display:flex;
      flex-direction:column;
      gap:10px;
      position:relative;
    }
    .filters-horizontal label{
      font-size:11px;
      color:#64748b;
      font-weight:800;
      text-transform:uppercase;
      letter-spacing:1px;
      display:flex;
      align-items:center;
      gap:6px;
      transition:all .3s ease;
    }
    .filters-horizontal .group:hover label{
      color:#6366f1;
      transform:translateX(2px);
    }
    .filters-horizontal select,.filters-horizontal input{
      width:100%;
      padding:14px 16px;
      border-radius:14px;
      border:2px solid #e2e8f0;
      background:linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
      font-size:14px;
      color:#1e293b;
      font-weight:600;
      font-family:'Outfit',sans-serif;
      outline:none;
      cursor:pointer;
      transition:all .3s cubic-bezier(0.4,0,0.2,1);
      box-shadow:0 2px 8px rgba(0,0,0,0.03);
      position:relative;
    }
    .filters-horizontal select:hover,.filters-horizontal input:hover{
      border-color:#a5b4fc;
      background:linear-gradient(135deg, #ffffff 0%, #eef2ff 100%);
      box-shadow:0 4px 12px rgba(99,102,241,0.15);
      transform:translateY(-1px);
    }
    .filters-horizontal select:focus,.filters-horizontal input:focus{
      border-color:#6366f1;
      background:#ffffff;
      box-shadow:0 0 0 4px rgba(99,102,241,.15), 0 4px 16px rgba(99,102,241,0.2);
      transform:translateY(-2px);
    }
    .filters-horizontal .btn{
      padding:14px 28px;
      font-size:14px;
      font-weight:700;
      white-space:nowrap;
      background:linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
      border:none;
      box-shadow:0 4px 16px rgba(99,102,241,0.3);
      transition:all .3s cubic-bezier(0.4,0,0.2,1);
    }
    .filters-horizontal .btn:hover{
      background:linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
      box-shadow:0 6px 24px rgba(99,102,241,0.4);
      transform:translateY(-2px) scale(1.02);
    }
    .filters-horizontal .btn:active{
      transform:translateY(0) scale(0.98);
    }

    /* Content Grid */
    .content{display:grid;grid-template-columns:repeat(12,1fr);gap:24px}
    .card{
      background:white;
      border:2px solid var(--ring);
      border-radius:16px;
      padding:28px;
      min-height:180px;
      display:flex;
      flex-direction:column;
      box-shadow:0 4px 16px var(--shadow);
      transition:all .3s ease;
      position:relative;
      overflow:hidden;
    }
    .card::before{
      content:'';position:absolute;top:0;left:0;right:0;height:4px;
      background:linear-gradient(90deg,var(--acc1),var(--acc4),var(--acc3));
      opacity:0;transition:opacity .3s;
    }
    .card:hover{
      border-color:var(--acc1);
      transform:translateY(-4px);
      box-shadow:0 12px 32px var(--shadow-lg);
    }
    .card:hover::before{opacity:1}
    .card h3{
      margin:0 0 20px;
      font-size:13px;
      color:var(--muted);
      font-weight:800;
      text-transform:uppercase;
      letter-spacing:1.2px;
    }
    
    /* KPI Cards - Modern Advanced Design */
    .kpi-hero{
      display:grid;
      grid-template-columns:280px 1fr;
      gap:24px;
      align-items:stretch;
    }
    
    /* Main Circle - Enhanced with 3D effect */
    .kpi-main-circle{
      width:280px;
      height:280px;
      border-radius:50%;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      background:linear-gradient(135deg,#6366f1,#ec4899,#8b5cf6);
      position:relative;
      overflow:hidden;
      box-shadow:0 20px 60px rgba(99,102,241,.3),
                 0 0 0 8px rgba(255,255,255,.5),
                 inset 0 0 60px rgba(255,255,255,.3);
      animation:pulse-glow 4s ease-in-out infinite;
    }
    @keyframes pulse-glow{
      0%,100%{box-shadow:0 20px 60px rgba(99,102,241,.3),0 0 0 8px rgba(255,255,255,.5),inset 0 0 60px rgba(255,255,255,.3)}
      50%{box-shadow:0 25px 70px rgba(99,102,241,.4),0 0 0 12px rgba(255,255,255,.6),inset 0 0 80px rgba(255,255,255,.4)}
    }
    .kpi-main-circle::before{
      content:'';
      position:absolute;
      top:-50%;left:-50%;
      width:200%;height:200%;
      background:linear-gradient(45deg,transparent,rgba(255,255,255,.3),transparent);
      transform:rotate(45deg);
      animation:shine 6s linear infinite;
    }
    @keyframes shine{
      0%{transform:rotate(45deg) translateY(-100%)}
      100%{transform:rotate(45deg) translateY(100%)}
    }
    .kpi-main-label{
      font-size:12px;
      color:rgba(255,255,255,.85);
      font-weight:800;
      text-transform:uppercase;
      letter-spacing:2px;
      margin-bottom:12px;
      z-index:2;
      text-shadow:0 2px 8px rgba(0,0,0,.2);
    }
    .kpi-main-value{
      font-size:72px;
      font-weight:900;
      line-height:1;
      font-family:'Space Grotesk',sans-serif;
      color:white;
      z-index:2;
      text-shadow:0 4px 12px rgba(0,0,0,.2);
      animation:countUp 1s ease-out;
    }
    @keyframes countUp{
      0%{transform:scale(0.5);opacity:0}
      100%{transform:scale(1);opacity:1}
    }
    
    /* KPI Grid - Modern Cards with Glassmorphism */
    .kpi-grid{
      display:grid;
      grid-template-columns:repeat(4,1fr);
      gap:16px;
      align-items:stretch;
    }
    .kpi-item{
      background:linear-gradient(135deg,rgba(255,255,255,.95),rgba(255,255,255,.85));
      backdrop-filter:blur(20px);
      border:1px solid rgba(255,255,255,.6);
      border-radius:20px;
      padding:24px 20px;
      text-align:center;
      transition:all .4s cubic-bezier(0.4,0,0.2,1);
      position:relative;
      overflow:hidden;
      box-shadow:0 4px 24px rgba(0,0,0,.06),
                 inset 0 1px 0 rgba(255,255,255,.9);
    }
    .kpi-item::before{
      content:'';
      position:absolute;
      top:0;left:0;right:0;
      height:4px;
      background:linear-gradient(90deg,var(--kpi-color),var(--kpi-color-light));
      border-radius:20px 20px 0 0;
      transform:scaleX(0);
      transform-origin:left;
      transition:transform .6s cubic-bezier(0.4,0,0.2,1);
    }
    .kpi-item::after{
      content:'';
      position:absolute;
      top:50%;left:50%;
      width:100%;height:100%;
      background:radial-gradient(circle,var(--kpi-color)05,transparent 70%);
      transform:translate(-50%,-50%) scale(0);
      transition:transform .6s cubic-bezier(0.4,0,0.2,1);
      border-radius:50%;
    }
    .kpi-item:hover{
      transform:translateY(-8px) scale(1.02);
      box-shadow:0 20px 40px rgba(0,0,0,.12),
                 0 0 0 1px var(--kpi-color)30,
                 inset 0 1px 0 rgba(255,255,255,1);
      border-color:var(--kpi-color)50;
    }
    .kpi-item:hover::before{transform:scaleX(1)}
    .kpi-item:hover::after{transform:translate(-50%,-50%) scale(1.5)}
    
    .kpi-label{
      font-size:11px;
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:1.2px;
      font-weight:800;
      margin-bottom:16px;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:6px;
    }
    .kpi-label-icon{
      font-size:14px;
      filter:grayscale(1);
      transition:filter .3s ease;
    }
    .kpi-item:hover .kpi-label-icon{
      filter:grayscale(0);
    }
    .kpi-value{
      font-size:44px;
      font-weight:900;
      margin-bottom:8px;
      font-family:'Space Grotesk',sans-serif;
      line-height:1;
      position:relative;
      z-index:1;
    }
    .kpi-percent{
      font-size:12px;
      color:var(--muted);
      font-weight:700;
      position:relative;
      z-index:1;
    }
    .kpi-progress{
      width:100%;
      height:4px;
      background:rgba(0,0,0,.06);
      border-radius:4px;
      overflow:hidden;
      margin-top:12px;
      position:relative;
    }
    .kpi-progress-bar{
      height:100%;
      background:linear-gradient(90deg,var(--kpi-color),var(--kpi-color-light));
      border-radius:4px;
      transition:width 1s cubic-bezier(0.4,0,0.2,1);
      box-shadow:0 0 12px var(--kpi-color)60;
      animation:progressFlow 2s ease-in-out infinite;
    }
    @keyframes progressFlow{
      0%,100%{filter:brightness(1)}
      50%{filter:brightness(1.2)}
    }
    
    /* Color scheme for each KPI */
    .kpi-item:nth-child(1){--kpi-color:#10b981;--kpi-color-light:#34d399}
    .kpi-item:nth-child(1) .kpi-value{color:#10b981}
    .kpi-item:nth-child(2){--kpi-color:#ef4444;--kpi-color-light:#f87171}
    .kpi-item:nth-child(2) .kpi-value{color:#ef4444}
    .kpi-item:nth-child(3){--kpi-color:#f59e0b;--kpi-color-light:#fbbf24}
    .kpi-item:nth-child(3) .kpi-value{color:#f59e0b}
    .kpi-item:nth-child(4){--kpi-color:#3b82f6;--kpi-color-light:#60a5fa}
    .kpi-item:nth-child(4) .kpi-value{color:#3b82f6}
    .kpi-item:nth-child(5){--kpi-color:#ec4899;--kpi-color-light:#f472b6}
    .kpi-item:nth-child(5) .kpi-value{color:#ec4899}
    .kpi-item:nth-child(6){--kpi-color:#8b5cf6;--kpi-color-light:#a78bfa}
    .kpi-item:nth-child(6) .kpi-value{color:#8b5cf6}
    .kpi-item:nth-child(7){--kpi-color:#06b6d4;--kpi-color-light:#22d3ee}
    .kpi-item:nth-child(7) .kpi-value{color:#06b6d4}

    /* India Map */
    #indiaMapContainer{
      width:100%;height:700px;position:relative;
      border-radius:16px;overflow:hidden;
      border:2px solid var(--ring);
    }
    #indiaMap{width:100%;height:100%;z-index:1}
    .leaflet-container{
      background:#f8fafc;
      font-family:'Outfit',sans-serif;
    }
    .leaflet-popup-content-wrapper{
      background:white;border-radius:14px;
      box-shadow:0 12px 48px rgba(99,102,241,.3);
      border:3px solid var(--acc1);
    }
    .leaflet-popup-content{margin:24px;font-size:14px;color:var(--text)}
    .leaflet-popup-tip{background:white;border:3px solid var(--acc1)}
    .map-popup-state{
      font-size:20px;font-weight:900;color:var(--acc1);
      margin-bottom:16px;padding-bottom:12px;
      border-bottom:2px solid var(--ring);
      font-family:'Space Grotesk',sans-serif;
    }
    .map-popup-row{
      display:flex;justify-content:space-between;align-items:center;
      margin:12px 0;padding:10px 0;
    }
    .map-popup-label{
      font-size:12px;color:var(--muted);
      text-transform:uppercase;letter-spacing:.6px;font-weight:700;
    }
    .map-popup-value{
      font-size:22px;font-weight:900;
      font-family:'Space Grotesk',sans-serif;
      color:var(--text);
    }
    .map-popup-success{color:#10b981!important}
    .map-popup-pending{color:#8b5cf6!important}
    .map-popup-rejected{color:#f59e0b!important}
    
    .state-marker-pin{position:relative;width:60px;height:60px;display:flex;align-items:center;justify-content:center}
    .state-marker-inner{
      position:relative;z-index:2;
      background:white;
      border-radius:12px;
      padding:10px 14px;
      box-shadow:0 8px 24px rgba(99,102,241,.25);
      border:3px solid;
      font-weight:900;font-size:15px;
      font-family:'Space Grotesk',sans-serif;
      text-align:center;min-width:85px;
      transition:all .3s ease;cursor:pointer;
    }
    .state-marker-inner:hover{
      transform:translateY(-6px) scale(1.08);
      box-shadow:0 16px 48px rgba(99,102,241,.4);
    }
    .state-marker-name{
      font-size:10px;color:var(--muted);
      text-transform:uppercase;letter-spacing:.6px;margin-bottom:5px;
      font-family:'Outfit',sans-serif;
    }
    .state-marker-count{
      font-size:19px;font-weight:900;
      display:flex;align-items:center;justify-content:center;gap:5px;
    }
    .marker-ripple{
      position:absolute;width:100%;height:100%;border-radius:50%;
      background:radial-gradient(circle, rgba(99,102,241,.3) 0%, rgba(99,102,241,0) 70%);
      animation:rippleEffect 2.5s ease-in-out infinite;z-index:1;
    }
    @keyframes rippleEffect{
      0%{transform:scale(.8);opacity:.7}
      50%{transform:scale(1.3);opacity:.3}
      100%{transform:scale(.8);opacity:.7}
    }
    .state-marker-level-1{border-color:#10b981}
    .state-marker-level-1 .state-marker-count{color:#10b981}
    .state-marker-level-2{border-color:#22c55e}
    .state-marker-level-2 .state-marker-count{color:#22c55e}
    .state-marker-level-3{border-color:#84cc16}
    .state-marker-level-3 .state-marker-count{color:#84cc16}
    .state-marker-level-4{border-color:#eab308}
    .state-marker-level-4 .state-marker-count{color:#eab308}
    .state-marker-level-5{border-color:#f59e0b}
    .state-marker-level-5 .state-marker-count{color:#f59e0b}
    
    /* Map Stats Card - NEW */
    .map-stats{
      position:absolute;
      top:20px;
      right:20px;
      z-index:1000;
      background:white;
      border:2px solid var(--ring);
      border-radius:14px;
      padding:24px;
      min-width:280px;
      box-shadow:0 8px 32px var(--shadow-lg);
      backdrop-filter:blur(10px);
    }
    .map-stats-title{
      font-size:14px;
      font-weight:900;
      text-transform:uppercase;
      letter-spacing:1.5px;
      color:var(--acc1);
      font-family:'Space Grotesk',sans-serif;
      margin-bottom:16px;
      padding-bottom:12px;
      border-bottom:2px solid var(--ring);
    }
    .map-stat-row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:12px 0;
      border-bottom:1px solid var(--ring);
    }
    .map-stat-label{
      font-size:12px;
      color:var(--muted);
      font-weight:700;
      text-transform:uppercase;
      letter-spacing:0.5px;
    }
    .map-stat-value{
      font-size:22px;
      font-weight:900;
      font-family:'Space Grotesk',sans-serif;
    }
    .stat-success{color:var(--acc3)}
    .stat-warning{color:var(--acc2)}
    .stat-danger{color:#ef4444}
    .stat-primary{color:var(--acc1)}
    
    /* Map Controls - NEW */
    .map-controls{
      position:absolute;
      top:20px;
      left:20px;
      z-index:1000;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .map-control-btn{
      padding:10px 20px;
      background:white;
      border:2px solid var(--ring);
      border-radius:10px;
      color:var(--text);
      font-size:13px;
      font-weight:700;
      cursor:pointer;
      transition:all 0.3s;
      box-shadow:0 2px 8px var(--shadow);
    }
    .map-control-btn:hover{
      background:var(--acc1);
      color:white;
      border-color:var(--acc1);
      transform:translateX(4px);
      box-shadow:0 4px 16px rgba(99,102,241,.3);
    }
    
    .legend{
      position:absolute;bottom:20px;right:20px;
      background:white;
      padding:20px;border-radius:14px;
      box-shadow:0 8px 32px var(--shadow-lg);
      border:2px solid var(--ring);z-index:1000;
    }
    .legend-title{
      font-size:13px;font-weight:900;color:var(--text);
      margin-bottom:14px;text-transform:uppercase;letter-spacing:1.2px;
      font-family:'Space Grotesk',sans-serif;
    }
    .legend-item{
      display:flex;align-items:center;gap:10px;
      margin:8px 0;font-size:12px;font-weight:700;
    }
    .legend-color{
      width:30px;height:20px;border-radius:6px;
      border:2px solid var(--border);
      box-shadow:0 2px 6px var(--shadow);
    }

    .footer{
      padding:20px 40px;color:var(--muted);
      border-top:2px solid var(--ring);
      text-align:center;font-size:14px;
      background:white;
      font-weight:600;
    }

    /* Login */
    .overlay{
      position:fixed;inset:0;
      background:linear-gradient(135deg, rgba(99,102,241,.95) 0%, rgba(236,72,153,.95) 100%);
      display:grid;place-items:center;z-index:100;
      backdrop-filter:blur(15px);
    }
    .login{
      width:min(92vw,440px);
      background:white;
      border:2px solid rgba(255,255,255,.8);
      border-radius:20px;
      padding:40px;
      box-shadow:0 24px 80px rgba(0,0,0,.3);
      animation:slideIn .5s ease;
    }
    @keyframes slideIn{
      from{opacity:0;transform:translateY(30px)}
      to{opacity:1;transform:translateY(0)}
    }
    .login h2{
      margin:0 0 10px;font-size:28px;color:var(--text);font-weight:900;
      font-family:'Space Grotesk',sans-serif;
    }
    .login p{margin:0 0 28px;color:var(--muted);font-size:14px;font-weight:500}
    .field{display:flex;flex-direction:column;gap:8px;margin:18px 0}
    .field label{font-size:12px;color:var(--muted);font-weight:700;letter-spacing:.5px}
    .field input{
      padding:14px;border-radius:10px;
      border:2px solid var(--ring);
      background:white;color:var(--text);font-size:14px;
      transition:all .2s ease;
    }
    .field input:focus{
      outline:none;border-color:var(--acc1);
      box-shadow:0 0 0 3px rgba(99,102,241,.1);
    }
    .err{color:#ef4444;font-size:13px;min-height:18px;margin-top:10px;font-weight:600}

    @media (max-width: 1100px){
      .kpi-hero{grid-template-columns:1fr}
      .kpi-main-circle{margin:0 auto}
      .kpi-grid{grid-template-columns:repeat(auto-fit,minmax(160px,1fr))}
      .filters-horizontal{grid-template-columns:repeat(auto-fit,minmax(140px,1fr))}
      #indiaMapContainer{height:500px}
      .map-stats{position:relative;top:auto;right:auto;margin-bottom:16px}
    }
    @media (max-width: 640px){
      .bar{padding:16px 20px}
      .main{padding:20px;gap:20px}
      .kpi-grid{grid-template-columns:1fr}
      .header-actions{width:100%;justify-content:flex-start}
      #indiaMapContainer{height:400px}
      .filters-horizontal{grid-template-columns:1fr}
      .title{font-size:1.4rem}
    }
  </style>
</head>
<body>
<div class="app">
  <header>
    <div class="bar">
      <button class="hidden-theme-btn" onclick="window.location.href='theme-controller.html?key=theme2025'" title="Theme Controller (Authorized)"></button>
      <div class="logo">
        <span class="dot"></span>
        <h1 class="title">Coromandel CPC Campaign Dashboard</h1>
      </div>
      <div class="header-actions">
        <button class="btn" id="downloadBtn">📥 Download Data</button>
        <button class="btn btn-logout" id="logoutBtn">🔒 Logout</button>
      </div>
    </div>
  </header>

  <main class="main">
    <!-- Horizontal Filters -->
    <div class="filters-horizontal">
      <div class="group">
        <label for="dateRange">📅 Date Range</label>
        <input id="dateRange" placeholder="Select range" />
      </div>

      <div class="group" style="display:none">
        <label for="dateFrom">Date From</label>
        <input id="dateFrom" type="date" />
      </div>
      <div class="group" style="display:none">
        <label for="dateTo">Date To</label>
        <input id="dateTo" type="date" />
      </div>

      <div class="group">
        <label for="state">🌍 State</label>
        <select id="state"></select>
      </div>
      <div class="group">
        <label for="district">📍 District</label>
        <select id="district"></select>
      </div>
      <div class="group">
        <label for="retailer">🏪 Retailer</label>
        <select id="retailer"></select>
      </div>
      <div class="group">
        <label for="product">📦 Product</label>
        <select id="product"></select>
      </div>

      <div class="group">
        <label for="unit">📏 Quantity Unit</label>
        <select id="unit"></select>
      </div>

      <div class="group">
        <label for="status">✅ Status</label>
        <select id="status"></select>
      </div>

      <div class="group">
        <label for="source">📱 Source</label>
        <select id="source"></select>
      </div>

      <div class="group">
        <label for="pt">👥 PT</label>
        <select id="pt"></select>
      </div>

      <div class="group">
        <label for="zone">🌐 Zone</label>
        <select id="zone"></select>
      </div>

      <div class="group">
        <label for="hq">🏢 HQ</label>
        <select id="hq"></select>
      </div>

      <div class="group" style="display:flex;align-items:flex-end">
        <button class="btn" id="resetBtn" style="width:100%">🔄 Reset</button>
      </div>
    </div>

    <section class="content">
      <!-- Total Scans with Hero Design -->
      <div class="card" style="grid-column: span 12">
        <h3>📊 Campaign Performance Overview</h3>
        <div class="kpi-hero">
          <div class="kpi-main-circle">
            <div class="kpi-main-label">Total Scans</div>
            <div class="kpi-main-value" id="kpiTotalBig">0</div>
          </div>
          <div class="kpi-grid">
            <div class="kpi-item">
              <div class="kpi-label"><span class="kpi-label-icon">✅</span> Approved</div>
              <div class="kpi-value" id="kpiYes">0</div>
              <div class="kpi-percent" id="kpiYesPct">0%</div>
              <div class="kpi-progress">
                <div class="kpi-progress-bar" id="kpiYesProgress" style="width:0%"></div>
              </div>
            </div>
            <div class="kpi-item">
              <div class="kpi-label"><span class="kpi-label-icon">❌</span> Rejected</div>
              <div class="kpi-value" id="kpiNo">0</div>
              <div class="kpi-percent" id="kpiNoPct">0%</div>
              <div class="kpi-progress">
                <div class="kpi-progress-bar" id="kpiNoProgress" style="width:0%"></div>
              </div>
            </div>
            <div class="kpi-item">
              <div class="kpi-label"><span class="kpi-label-icon">⏳</span> Pending</div>
              <div class="kpi-value" id="kpiPending">0</div>
              <div class="kpi-percent" id="kpiPendingPct">0%</div>
              <div class="kpi-progress">
                <div class="kpi-progress-bar" id="kpiPendingProgress" style="width:0%"></div>
              </div>
            </div>
            <div class="kpi-item">
              <div class="kpi-label"><span class="kpi-label-icon">👨‍🌾</span> Total Farmers</div>
              <div class="kpi-value" id="kpiTotalFarmers">0</div>
              <div class="kpi-percent" id="kpiUniqueFarmers">Unique: 0</div>
              <div class="kpi-progress">
                <div class="kpi-progress-bar" id="kpiFarmersProgress" style="width:0%"></div>
              </div>
            </div>
            <div class="kpi-item">
              <div class="kpi-label"><span class="kpi-label-icon">🏪</span> Retailers</div>
              <div class="kpi-value" id="kpiActiveRetailers">0</div>
              <div class="kpi-percent" id="kpiTotalRetailers">of 0 total</div>
              <div class="kpi-progress">
                <div class="kpi-progress-bar" id="kpiRetailersProgress" style="width:0%"></div>
              </div>
            </div>
            <div class="kpi-item">
              <div class="kpi-label"><span class="kpi-label-icon">📞</span> Missed Calls</div>
              <div class="kpi-value" id="kpiMissedCalls">0</div>
              <div class="kpi-percent" id="kpiMissedCallsTotal">All States</div>
              <div class="kpi-progress">
                <div class="kpi-progress-bar" id="kpiMissedCallsProgress" style="width:0%"></div>
              </div>
            </div>
            <div class="kpi-item">
              <div class="kpi-label"><span class="kpi-label-icon">📱</span> Unique Calls</div>
              <div class="kpi-value" id="kpiUniqueMissedCalls">0</div>
              <div class="kpi-percent" id="kpiUniqueMissedCallsTotal">All States</div>
              <div class="kpi-progress">
                <div class="kpi-progress-bar" id="kpiUniqueMissedCallsProgress" style="width:0%"></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Status Chart -->
      <div class="card" style="grid-column: span 4">
        <h3>📈 Order Approval Status</h3>
        <canvas id="statusChart" height="280"></canvas>
      </div>

      <!-- Trend Chart - ENHANCED -->
      <div class="card" style="grid-column: span 8">
        <h3>📅 Time Trend (Scans per Day)</h3>
        <canvas id="trendChart" height="280"></canvas>
      </div>

      <!-- Top States Table -->
      <div class="card" style="grid-column: span 6">
        <h3>🌍 States by Scans</h3>
        <div id="statesTable" style="overflow-y:auto;max-height:380px;margin-top:12px"></div>
      </div>

      <!-- Retailer Performance -->
      <div class="card" style="grid-column: span 6">
        <h3>🏪 Retailer Performance</h3>
        <canvas id="retailerChart" height="240"></canvas>
      </div>

      <!-- District Scans -->
      <div class="card" style="grid-column: span 6">
        <h3>📍 District-wise Scans</h3>
        <canvas id="districtChart" height="180"></canvas>
      </div>

      <!-- Product Basket -->
      <div class="card" style="grid-column: span 6">
        <h3>📦 Product Basket</h3>
        <canvas id="productChart" height="180"></canvas>
      </div>

      <!-- NEW: Participation Share by Source (LEFT) -->
      <div class="card" style="grid-column: span 4" data-chart="sourceChart">
        <h3>📱 Participation Share by Source</h3>
        <canvas id="sourceChart" height="280"></canvas>
      </div>

      <!-- NEW: Submission Status by PT (Top 10) (RIGHT) -->
      <div class="card" style="grid-column: span 8" data-chart="ptStatusChart">
        <h3>📊 Submission Status by PT (Top 10)</h3>
        <canvas id="ptStatusChart" height="280"></canvas>
      </div>

      <!-- India Map with Stats Card -->
      <div class="card" style="grid-column: span 12">
        <h3>🗺️ India - State-wise Distribution</h3>
        <div id="indiaMapContainer">
          <div id="indiaMap"></div>
          
          <!-- Map Controls - NEW -->
          <div class="map-controls">
            <button class="map-control-btn" id="mapResetBtn">🔄 Reset Map Filter</button>
          </div>
          
          <!-- Live Stats Card - NEW -->
          <div class="map-stats">
            <div class="map-stats-title">📊 Live Statistics</div>
            <div class="map-stat-row">
              <span class="map-stat-label">🌍 Active States</span>
              <span class="map-stat-value stat-primary" id="mapActiveStates">0</span>
            </div>
            <div class="map-stat-row">
              <span class="map-stat-label">✅ Approved</span>
              <span class="map-stat-value stat-success" id="mapApproved">0</span>
            </div>
            <div class="map-stat-row">
              <span class="map-stat-label">⏳ Pending</span>
              <span class="map-stat-value stat-warning" id="mapPending">0</span>
            </div>
            <div class="map-stat-row" style="border-bottom:none">
              <span class="map-stat-label">❌ Rejected</span>
              <span class="map-stat-value stat-danger" id="mapRejected">0</span>
            </div>
          </div>
          
          <!-- Legend -->
          <div class="legend">
            <div class="legend-title">Approval Levels</div>
            <div class="legend-item"><div class="legend-color" style="background:#10b981"></div><span>Elite (1000+)</span></div>
            <div class="legend-item"><div class="legend-color" style="background:#22c55e"></div><span>High (500-999)</span></div>
            <div class="legend-item"><div class="legend-color" style="background:#84cc16"></div><span>Medium (250-499)</span></div>
            <div class="legend-item"><div class="legend-color" style="background:#eab308"></div><span>Growing (100-249)</span></div>
            <div class="legend-item"><div class="legend-color" style="background:#f59e0b"></div><span>Emerging (1-99)</span></div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <div class="footer">
    © 2025 Coromandel CPC
  </div>
</div>

<!-- Login Overlay -->
<div class="overlay" id="loginOverlay">
  <form class="login" id="loginForm">
    <h2>🔐 Secure Access</h2>
    <p>Please authenticate to view the campaign dashboard.</p>
    <div class="field">
      <label>👤 Username</label>
      <input id="u" autocomplete="username" placeholder="Enter username" />
    </div>
    <div class="field">
      <label>🔑 Password</label>
      <input id="p" type="password" autocomplete="current-password" placeholder="Enter password" />
    </div>
    <button class="btn" type="submit" style="width:100%;margin-top:12px">Login</button>
    <div class="err" id="err"></div>
  </form>
</div>

<script>
  const CSV_URL = './data.csv';
  const REFERENCE_CSV_URL = './reference.csv';

  // Login
  const USERS = {
    'digicides': { password: 'cpc@coro', role: 'user' },
    'developer': { password: 'de^el0per', role: 'developer' }
  };
  
  const overlay = document.getElementById('loginOverlay');
  const form = document.getElementById('loginForm');
  const errEl = document.getElementById('err');
  const LS_KEY = 'cpc_login_ok';
  const LS_ROLE_KEY = 'cpc_user_role';
  const LS_USERNAME_KEY = 'cpc_username';

  function unlock(){ 
    overlay.style.display='none';
    const userRole = localStorage.getItem(LS_ROLE_KEY);
    const themeBtn = document.querySelector('.hidden-theme-btn');
    if(themeBtn) {
      if(userRole === 'developer') {
        themeBtn.style.display = 'block';
      } else {
        themeBtn.style.display = 'none';
      }
    }
  }
  
  // Check if already logged in
  if(localStorage.getItem(LS_KEY)==='1'){ 
    unlock();
  }
  
  form.addEventListener('submit', (e)=>{
    e.preventDefault();
    const u = document.getElementById('u').value.trim();
    const p = document.getElementById('p').value;
    
    // Check if user exists and password matches
    if(USERS[u] && USERS[u].password === p){
      localStorage.setItem(LS_KEY,'1');
      localStorage.setItem(LS_ROLE_KEY, USERS[u].role);
      localStorage.setItem(LS_USERNAME_KEY, u);
      
      unlock();
    } else {
      errEl.textContent = 'Invalid credentials. Please try again.';
    }
  });

  // Logout
  document.getElementById('logoutBtn').addEventListener('click', ()=>{
    if(confirm('Are you sure you want to logout?')){
      // Clear all login-related data
      localStorage.removeItem(LS_KEY);
      localStorage.removeItem(LS_ROLE_KEY);
      localStorage.removeItem(LS_USERNAME_KEY);
      location.reload();
    }
  });

  // Map Reset Button - NEW
  document.getElementById('mapResetBtn').addEventListener('click', ()=>{
    if(FILTERS.state){
      FILTERS.state = '';
      selState.value = '';
      render();
    }
  });

  // Utilities
  const trim = (s)=> (s==null?'' : String(s).trim());
  const toDateKey = (dt)=>{
    if(!dt) return '';
    const d = new Date(dt.replace(/-/g,'/'));
    if(isNaN(d)) return '';
    return d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0');
  };
  
  // Parse date from reference.csv format (DD-MMM-YY or DD-MMM-YYYY)
  const parseReferenceDate = (dateStr) => {
    if(!dateStr) return '';
    const s = trim(dateStr);
    if(!s) return '';
    
    // Try to parse DD-MMM-YY format (e.g., "10-Sep-25")
    const parts = s.split('-');
    if(parts.length === 3){
      const day = parts[0].padStart(2, '0');
      const monthStr = parts[1];
      let year = parts[2];
      
      // Convert 2-digit year to 4-digit (25 -> 2025)
      if(year.length === 2){
        const yearNum = parseInt(year);
        year = yearNum < 50 ? '20' + year : '19' + year;
      }
      
      // Month mapping
      const months = {
        'jan': '01', 'feb': '02', 'mar': '03', 'apr': '04',
        'may': '05', 'jun': '06', 'jul': '07', 'aug': '08',
        'sep': '09', 'oct': '10', 'nov': '11', 'dec': '12'
      };
      
      const month = months[monthStr.toLowerCase()];
      if(month){
        return year + '-' + month + '-' + day;
      }
    }
    
    // Fallback to standard date parsing
    return toDateKey(s);
  };
  
  function uniqSorted(arr){ return [...new Set(arr.filter(Boolean))].sort((a,b)=>a.localeCompare(b)); }

  function parseProducts(cartStr){
    const map = new Map();
    const s = trim(cartStr);
    if(!s) return map;
    const parts = s.split(',');
    for(const raw of parts){
      const item = raw.trim();
      const m = item.match(/^(.+?)\s*-\s*qty\s*(\d+)/i) || item.match(/^(.+?)\s*$/);
      if(m){
        const name = trim(m[1]).replace(/\s{2,}/g,' ');
        const q = m[2] ? Number(m[2]) : 1;
        map.set(name, (map.get(name)||0)+ (isFinite(q)? q : 1));
      }
    }
    return map;
  }

  function parseCartItems(cartStr){
    const s = trim(cartStr);
    if(!s) return [];
    const parts = s.split(',');
    const items = [];
    for(const raw of parts){
      const t = raw.trim();
      const m = t.match(/^(.+?)\s*-\s*qty\s*(\d+)(?:\s*-\s*(.+))?$/i);
      if(m){
        items.push({ name: trim(m[1]), qty: Number(m[2])||1, unit: m[3]?trim(m[3]):'' });
      } else {
        items.push({ name: t, qty: 1, unit: '' });
      }
    }
    return items;
  }

  // State
  let RAW = [];
  let REFERENCE_DATA = []; // PT/Missed Calls reference data
  let REFERENCE_GRAND_TOTAL = null; // Grand Total row (excluded from filters)
  let FILTERS = { dateFrom:'', dateTo:'', state:'', district:'', retailer:'', product:'', unit:'', status:'', source:'', pt:'', zone:'', hq:'' };

  // DOM
  const selDateFrom = document.getElementById('dateFrom');
  const selDateTo = document.getElementById('dateTo');
  const selDateRange = document.getElementById('dateRange');
  const selState = document.getElementById('state');
  const selDistrict = document.getElementById('district');
  const selRetailer = document.getElementById('retailer');
  const selProduct = document.getElementById('product');
  const selUnit = document.getElementById('unit');
  const selStatus = document.getElementById('status');
  const selSource = document.getElementById('source');
  const selPT = document.getElementById('pt');
  const selZone = document.getElementById('zone');
  const selHQ = document.getElementById('hq');
  
  flatpickr("#dateRange",{
    mode:"range",
    dateFormat:"Y-m-d",
    onChange:(dates)=>{
      if(dates.length===2){
        FILTERS.dateFrom = dates[0].toISOString().slice(0,10);
        FILTERS.dateTo   = dates[1].toISOString().slice(0,10);
        selDateFrom.value = FILTERS.dateFrom;
        selDateTo.value   = FILTERS.dateTo;
        populateFilters(RAW, REFERENCE_DATA, true);
        render();
      }
    }
  });

  document.getElementById('resetBtn').addEventListener('click', ()=>{
    FILTERS = { dateFrom:'', dateTo:'', state:'', district:'', retailer:'', product:'', unit:'', status:'', source:'', pt:'', zone:'', hq:'' };
    selDateFrom.value = selDateTo.value = '';
    selDateRange._flatpickr && selDateRange._flatpickr.clear();
    selState.value = selDistrict.value = selRetailer.value = selProduct.value = selUnit.value = selStatus.value = '';
    selSource.value = selPT.value = selZone.value = selHQ.value = '';
    populateFilters(RAW, REFERENCE_DATA, false); // Reset to full dataset
    render();
  });

  // Download CSV
  document.getElementById('downloadBtn').addEventListener('click', ()=>{
    const filtered = applyFilters(RAW);
    if(filtered.length === 0){ alert('No data to download!'); return; }
    const csv = Papa.unparse(filtered);
    const blob = new Blob([csv], {type:'text/csv'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'cpc_data_export_' + new Date().toISOString().slice(0,10) + '.csv';
    a.click();
    URL.revokeObjectURL(url);
  });

  // Charts
  const charts = {};
  function makeChart(id, type, data, opts){
    const ctx = document.getElementById(id).getContext('2d');
    if(charts[id]){ 
      charts[id].data = data; 
      charts[id].options = opts; 
      charts[id].update(); 
      return charts[id]; 
    }
    charts[id] = new Chart(ctx, { type, data, options: opts });
    return charts[id];
  }
  function palette(n){
    const base = [ '#6366f1','#ec4899','#10b981','#f59e0b','#3b82f6','#8b5cf6','#14b8a6','#f97316' ];
    const arr = []; for(let i=0;i<n;i++) arr.push(base[i%base.length]);
    return arr;
  }

  // Apply Filters
  function applyFilters(rows){
    const f = FILTERS;
    return rows.filter(r=>{
      if(f.dateFrom || f.dateTo){
        const scanDate = toDateKey(trim(r['Scan Date']));
        if(f.dateFrom && scanDate < f.dateFrom) return false;
        if(f.dateTo && scanDate > f.dateTo) return false;
      }
      if(f.state && trim(r.State)!==f.state) return false;
      if(f.district && trim(r.District)!==f.district) return false;
      if(f.retailer && trim(r['Retailer Name'])!==f.retailer) return false;
      if(f.status && trim((r['Submission Status']||'').toLowerCase())!==f.status.toLowerCase()) return false;
      if(f.source && trim(r.Source||'')!==f.source) return false;
      if(f.pt && trim(r.PT||'')!==f.pt) return false;
      if(f.zone && trim(r.Zone||'')!==f.zone) return false;

      if(f.product){
        const m = parseProducts(r['Cart Items']);
        if(!m.has(f.product)) return false;
      }

      if(f.unit){
        const items = parseCartItems(r['Cart Items']);
        const has = items.some(it=>{
          if(f.product) return it.name===f.product && it.unit===f.unit;
          return it.unit===f.unit;
        });
        if(!has) return false;
      }

      return true;
    });
  }

  function updateKpis(rows){
    const total = rows.length;
    const yes = rows.filter(r=>/^yes$/i.test(trim(r['Submission Status']))).length;
    const pending = rows.filter(r=>/^pending$/i.test(trim(r['Submission Status']))).length;
    const no = rows.filter(r=>/^no$/i.test(trim(r['Submission Status']))).length;
    
    const allPhones = rows.map(r=>trim(r['Phone Number'])).filter(p=>p);
    const uniquePhones = new Set(allPhones);
    const totalFarmers = allPhones.length;
    const uniqueFarmers = uniquePhones.size;
    
    const activeRINs = new Set(rows.map(r=>trim(r['RIN'])).filter(rin=>rin));
    const activeRetailers = activeRINs.size;
    
    const STATE_RETAILER_TOTALS = {
      'West Bengal': 183,
      'Maharashtra': 616,
      'Telangana': 161,
      'Andhra Pradesh': 307,
      'Karnataka': 636
    };
    
    let totalRetailers = 1903;
    if(FILTERS.state){
      totalRetailers = STATE_RETAILER_TOTALS[FILTERS.state] || 0;
      if(totalRetailers === 0){
        const stateRetailers = RAW.filter(r=>trim(r.State)===FILTERS.state);
        const stateRetailerRINs = new Set(stateRetailers.map(r=>trim(r['RIN'])).filter(rin=>rin));
        totalRetailers = stateRetailerRINs.size;
      }
    }
    
    // Calculate Missed Calls from reference.csv (dynamic based on filters)
    // Check if any reference-related filters are applied
    const hasReferenceFilters = FILTERS.state || FILTERS.zone || FILTERS.pt || FILTERS.hq || FILTERS.dateFrom || FILTERS.dateTo;
    
    let missedCallsDisplay = 0;
    let missedCallsUniqueDisplay = 0;
    let missedCallsTotal = 0;
    let missedCallsUnique = 0;
    
    if(!hasReferenceFilters && REFERENCE_GRAND_TOTAL){
      // No filters applied - use Grand Total row values
      missedCallsDisplay = REFERENCE_GRAND_TOTAL.total;
      missedCallsUniqueDisplay = REFERENCE_GRAND_TOTAL.unique;
      missedCallsTotal = REFERENCE_GRAND_TOTAL.total;
      missedCallsUnique = REFERENCE_GRAND_TOTAL.unique;
    } else {
      // Filters applied - calculate from filtered PT data
      const filteredReferenceData = REFERENCE_DATA.filter(r => {
        // Apply date range filter if present
        if(FILTERS.dateFrom || FILTERS.dateTo){
          const refDate = parseReferenceDate(trim(r['Date Processed'] || ''));
          
          // Skip if date parsing failed
          if(!refDate) return true; // Include rows without valid dates
          
          if(FILTERS.dateFrom && refDate < FILTERS.dateFrom) return false;
          if(FILTERS.dateTo && refDate > FILTERS.dateTo) return false;
        }
        
        // Apply common filters: State, Zone, PT
        if(FILTERS.state && trim(r.State) !== FILTERS.state) return false;
        if(FILTERS.zone && trim(r.ZONE) !== FILTERS.zone) return false;
        // PT filter (maps to Name column in reference.csv)
        if(FILTERS.pt && trim(r.Name) !== FILTERS.pt) return false;
        // HQ filter (unique to reference data)
        if(FILTERS.hq && trim(r.HQ) !== FILTERS.hq) return false;
        return true;
      });
      
      // Debug: Log filtered data when date filter is active
      if(FILTERS.dateFrom || FILTERS.dateTo){
        console.log('📅 Date Range Filter Applied to Missed Calls:', {
          dateFrom: FILTERS.dateFrom,
          dateTo: FILTERS.dateTo,
          totalReferenceRows: REFERENCE_DATA.length,
          filteredRows: filteredReferenceData.length,
          sampleFilteredRows: filteredReferenceData.slice(0, 5).map(r => ({
            date: r['Date Processed'],
            parsedDate: parseReferenceDate(r['Date Processed']),
            name: r.Name,
            total: r['Total Missed Calls'],
            unique: r['Total Unique Missed Calls']
          }))
        });
      }
      
      for(const r of filteredReferenceData){
        missedCallsDisplay += Number(r['Total Missed Calls']) || 0;
        missedCallsUniqueDisplay += Number(r['Total Unique Missed Calls']) || 0;
      }
      
      // Debug: Log calculated totals
      if(FILTERS.dateFrom || FILTERS.dateTo){
        console.log('📊 Missed Calls Calculation:', {
          filteredRowCount: filteredReferenceData.length,
          calculatedTotal: missedCallsDisplay,
          calculatedUnique: missedCallsUniqueDisplay
        });
      }
      
      // Grand totals for context (use Grand Total row if available, otherwise calculate)
      if(REFERENCE_GRAND_TOTAL){
        missedCallsTotal = REFERENCE_GRAND_TOTAL.total;
        missedCallsUnique = REFERENCE_GRAND_TOTAL.unique;
      } else {
        for(const r of REFERENCE_DATA){
          missedCallsTotal += Number(r['Total Missed Calls']) || 0;
          missedCallsUnique += Number(r['Total Unique Missed Calls']) || 0;
        }
      }
    }
    
    document.getElementById('kpiTotalBig').textContent = total.toLocaleString();
    document.getElementById('kpiYes').textContent = yes.toLocaleString();
    document.getElementById('kpiNo').textContent = no.toLocaleString();
    document.getElementById('kpiPending').textContent = pending.toLocaleString();
    document.getElementById('kpiTotalFarmers').textContent = totalFarmers.toLocaleString();
    document.getElementById('kpiUniqueFarmers').textContent = `Unique: ${uniqueFarmers.toLocaleString()}`;
    document.getElementById('kpiActiveRetailers').textContent = activeRetailers.toLocaleString();
    document.getElementById('kpiTotalRetailers').textContent = `of ${totalRetailers.toLocaleString()} total`;
    document.getElementById('kpiMissedCalls').textContent = missedCallsDisplay.toLocaleString();
    document.getElementById('kpiMissedCallsTotal').textContent = FILTERS.state ? FILTERS.state : 'All States';
    document.getElementById('kpiUniqueMissedCalls').textContent = missedCallsUniqueDisplay.toLocaleString();
    document.getElementById('kpiUniqueMissedCallsTotal').textContent = FILTERS.state ? FILTERS.state : 'All States';
    
    const yesPct = total > 0 ? ((yes / total) * 100).toFixed(1) : '0.0';
    const noPct = total > 0 ? ((no / total) * 100).toFixed(1) : '0.0';
    const pendingPct = total > 0 ? ((pending / total) * 100).toFixed(1) : '0.0';
    
    document.getElementById('kpiYesPct').textContent = `${yesPct}% of total`;
    document.getElementById('kpiNoPct').textContent = `${noPct}% of total`;
    document.getElementById('kpiPendingPct').textContent = `${pendingPct}% of total`;
    
    // Update animated progress bars
    setTimeout(() => {
      document.getElementById('kpiYesProgress').style.width = `${yesPct}%`;
      document.getElementById('kpiNoProgress').style.width = `${noPct}%`;
      document.getElementById('kpiPendingProgress').style.width = `${pendingPct}%`;
      
      // Calculate progress for other KPIs
      const farmersProgress = totalFarmers > 0 ? Math.min((uniqueFarmers / totalFarmers) * 100, 100) : 0;
      const retailersProgress = totalRetailers > 0 ? Math.min((activeRetailers / totalRetailers) * 100, 100) : 0;
      const missedCallsProgress = missedCallsTotal > 0 ? Math.min((missedCallsDisplay / missedCallsTotal) * 100, 100) : 0;
      const uniqueCallsProgress = missedCallsUnique > 0 ? Math.min((missedCallsUniqueDisplay / missedCallsUnique) * 100, 100) : 0;
      
      document.getElementById('kpiFarmersProgress').style.width = `${farmersProgress.toFixed(1)}%`;
      document.getElementById('kpiRetailersProgress').style.width = `${retailersProgress.toFixed(1)}%`;
      document.getElementById('kpiMissedCallsProgress').style.width = `${missedCallsProgress.toFixed(1)}%`;
      document.getElementById('kpiUniqueMissedCallsProgress').style.width = `${uniqueCallsProgress.toFixed(1)}%`;
    }, 100);
  }

  function buildCounts(rows, key){
    const m = new Map();
    for(const r of rows){
      const k = trim(r[key]); if(!k) continue;
      m.set(k, (m.get(k)||0)+1);
    }
    return [...m.entries()].sort((a,b)=>b[1]-a[1]);
  }

  function renderStatesTable(rows){
    const states = buildCounts(rows, 'State').slice(0, 10);
    let html = '<div style="font-size:13px">';
    states.forEach((s, i)=>{
      const bar = Math.round((s[1] / (states[0][1] || 1)) * 100);
      const colors = ['#6366f1','#ec4899','#10b981','#f59e0b','#3b82f6','#8b5cf6','#14b8a6','#f97316'];
      const color = colors[i % colors.length];
      html += `<div style="margin-bottom:18px">
        <div style="display:flex;justify-content:space-between;margin-bottom:8px">
          <span style="font-weight:700;color:var(--text)">${i+1}. ${s[0]}</span>
          <span style="color:${color};font-weight:900;font-family:Space Grotesk,sans-serif">${s[1].toLocaleString()}</span>
        </div>
        <div style="width:100%;height:10px;background:#e5e7eb;border-radius:6px;overflow:hidden">
          <div style="width:${bar}%;height:100%;background:${color};border-radius:6px;transition:width .5s ease"></div>
        </div>
      </div>`;
    });
    html += '</div>';
    document.getElementById('statesTable').innerHTML = html;
  }

  function renderCharts(rows){
    // Status
    const sYes = rows.filter(r=>/^yes$/i.test(trim(r['Submission Status']))).length;
    const sNo = rows.filter(r=>/^no$/i.test(trim(r['Submission Status']))).length;
    const sPending = rows.filter(r=>/^pending$/i.test(trim(r['Submission Status']))).length;
    makeChart('statusChart','doughnut',{
      labels:['Approved','Rejected','Pending'],
      datasets:[{ 
        data:[sYes,sNo,sPending], 
        backgroundColor:['#10b981','#ef4444','#f59e0b'], 
        borderWidth: 4,
        borderColor: '#fff',
        hoverOffset: 10
      }]
    },{
      plugins:{ 
        legend:{ 
          display: true,
          position: 'bottom',
          labels:{ 
            color: '#1f2937', 
            padding: 18, 
            font:{ size: 13, weight: '800', family: 'Outfit' },
            usePointStyle: true,
            pointStyle: 'circle',
            generateLabels: function(chart) {
              const data = chart.data;
              if (data.labels.length && data.datasets.length) {
                return data.labels.map((label, i) => {
                  const value = data.datasets[0].data[i];
                  const total = data.datasets[0].data.reduce((a, b) => a + b, 0);
                  const percent = ((value / total) * 100).toFixed(1);
                  return {
                    text: `${label}: ${value.toLocaleString()} (${percent}%)`,
                    fillStyle: data.datasets[0].backgroundColor[i],
                    hidden: false,
                    index: i
                  };
                });
              }
              return [];
            }
          } 
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              const label = context.label || '';
              const value = context.parsed || 0;
              const total = context.dataset.data.reduce((a, b) => a + b, 0);
              const percent = ((value / total) * 100).toFixed(1);
              return `${label}: ${value.toLocaleString()} (${percent}%)`;
            }
          }
        }
      },
      cutout:'65%'
    });

    // Trend - ENHANCED with gradient area and better styling
    const trendMap = new Map();
    for(const r of rows){ const k = toDateKey(trim(r['Scan Date'])); if(k) trendMap.set(k,(trendMap.get(k)||0)+1); }
    const trend = [...trendMap.entries()].sort((a,b)=>a[0].localeCompare(b[0]));
    
    // Create gradient for the trend chart
    const trendCanvas = document.getElementById('trendChart');
    const trendCtx = trendCanvas.getContext('2d');
    const trendGradient = trendCtx.createLinearGradient(0, 0, 0, 280);
    trendGradient.addColorStop(0, 'rgba(99,102,241,0.4)');
    trendGradient.addColorStop(0.5, 'rgba(99,102,241,0.2)');
    trendGradient.addColorStop(1, 'rgba(99,102,241,0.05)');
    
    makeChart('trendChart','line',{
      labels: trend.map(x=>x[0]),
      datasets:[{ 
        label: 'Daily Scans',
        data: trend.map(x=>x[1]), 
        borderColor:'#6366f1',
        backgroundColor: trendGradient,
        borderWidth:4, 
        tension:.4,
        fill:true,
        pointRadius:6,
        pointHoverRadius:9,
        pointBackgroundColor:'#6366f1',
        pointBorderColor:'#fff',
        pointBorderWidth:3,
        pointHoverBackgroundColor:'#fff',
        pointHoverBorderColor:'#6366f1',
        pointHoverBorderWidth:3
      }]
    },{ 
      scales:{ 
        x:{ 
          ticks:{ 
            color:'#6b7280', 
            maxRotation:45, 
            font:{weight:'600',size:11,family:'Outfit'} 
          }, 
          grid:{display:false},
          border:{color:'#e5e7eb',width:2}
        }, 
        y:{ 
          ticks:{ 
            color:'#6b7280', 
            font:{weight:'700',size:12,family:'Space Grotesk'} 
          }, 
          grid:{ color:'#e5e7eb',lineWidth:1 },
          border:{color:'#e5e7eb',width:2}
        } 
      }, 
      plugins:{ 
        legend:{ 
          display:true,
          position:'top',
          align:'end',
          labels:{
            color:'#1f2937',
            font:{size:12,weight:'700',family:'Outfit'},
            usePointStyle:true,
            pointStyle:'circle'
          }
        },
        tooltip:{
          backgroundColor:'rgba(15,23,42,0.95)',
          titleColor:'#fff',
          titleFont:{size:13,weight:'700',family:'Outfit'},
          bodyColor:'#fff',
          bodyFont:{size:14,weight:'600',family:'Space Grotesk'},
          padding:12,
          borderColor:'#6366f1',
          borderWidth:2,
          cornerRadius:8
        }
      },
      interaction:{
        intersect:false,
        mode:'index'
      }
    });

    // Retailer
    const retailers = buildCounts(rows,'Retailer Name').slice(0,8);
    const retailerApproved = retailers.map(r => rows.filter(row => trim(row['Retailer Name']) === r[0] && /^yes$/i.test(trim(row['Submission Status']))).length);
    const retailerPending  = retailers.map(r => rows.filter(row => trim(row['Retailer Name']) === r[0] && /^pending$/i.test(trim(row['Submission Status']))).length);
    const retailerRejected = retailers.map(r => rows.filter(row => trim(row['Retailer Name']) === r[0] && /^no$/i.test(trim(row['Submission Status']))).length);
    
    makeChart('retailerChart','bar',{
      labels: retailers.map(x=>x[0]),
      datasets:[
        { label: 'Approved', data: retailerApproved, backgroundColor: '#10b981', borderRadius: 10, barThickness: 22 },
        { label: 'Pending',  data: retailerPending,  backgroundColor: '#8b5cf6', borderRadius: 10, barThickness: 22 },
        { label: 'Rejected', data: retailerRejected, backgroundColor: '#f59e0b', borderRadius: 10, barThickness: 22 }
      ]
    },{ 
      plugins: { 
        legend: { 
          display: true, 
          position: 'top', 
          labels: { 
            color: '#1f2937', 
            padding: 14, 
            font: { size: 12, weight: '700', family: 'Outfit' }, 
            usePointStyle: true, 
            pointStyle: 'circle' 
          } 
        } 
      }, 
      scales: { 
        x: { 
          ticks: { 
            color: '#1f2937', 
            maxRotation: 45, 
            minRotation: 25, 
            font: { size: 11, weight: '700', family: 'Outfit' } 
          }, 
          grid: { display: false } 
        }, 
        y: { 
          ticks: { color: '#6b7280', font: { weight: '700', family: 'Space Grotesk' } }, 
          grid: { color: '#e5e7eb' } 
        } 
      } 
    });

    // District
    const districts = buildCounts(rows,'District').slice(0,10);
    makeChart('districtChart','bar',{
      labels: districts.map(x=>x[0]),
      datasets:[{ 
        data: districts.map(x=>x[1]), 
        backgroundColor: palette(districts.length), 
        borderWidth:0, 
        borderRadius:8 
      }]
    },{ 
      indexAxis:'y', 
      plugins:{ legend:{ display:false } }, 
      scales:{ 
        x:{ ticks:{ color:'#6b7280', font:{weight:'700',family:'Space Grotesk'} }, grid:{color:'#e5e7eb'} }, 
        y:{ ticks:{ color:'#1f2937',font:{size:11,weight:'700',family:'Outfit'} }, grid:{display:false} } 
      } 
    });

    // Product
    const pMap = new Map();
    for(const r of rows){
      const m = parseProducts(r['Cart Items']);
      for(const [name,qty] of m){ pMap.set(name,(pMap.get(name)||0)+qty); }
    }
    const pArr = [...pMap.entries()].sort((a,b)=>b[1]-a[1]).slice(0,16);
    makeChart('productChart','bar',{
      labels: pArr.map(x=>x[0]),
      datasets:[{ 
        data: pArr.map(x=>x[1]), 
        backgroundColor: palette(pArr.length), 
        borderWidth:0, 
        borderRadius:10 
      }]
    },{ 
      plugins:{ legend:{ display:false } }, 
      scales:{ 
        x:{ 
          ticks:{ 
            color:'#1f2937', 
            maxRotation:45, 
            minRotation:20, 
            font:{size:10,weight:'700',family:'Outfit'} 
      }, 
      grid:{display:false} 
    }, 
    y:{ 
      ticks:{ color:'#6b7280', font:{weight:'700',family:'Space Grotesk'} }, 
      grid:{color:'#e5e7eb'} 
    } 
  } 
});

    // NEW: Submission Status by PT (Top 10)
    const ptStats = {};
    for(const r of rows){
      const pt = trim(r.PT||'');
      // Skip empty PT and exclude "Direct Landing Page" (it's a Source, not PT)
      if(!pt || pt.toLowerCase() === 'direct landing page') continue;
      if(!ptStats[pt]) ptStats[pt] = {yes:0, no:0, pending:0};
      const status = trim((r['Submission Status']||'').toLowerCase());
      if(status==='yes') ptStats[pt].yes++;
      else if(status==='no') ptStats[pt].no++;
      else if(status==='pending') ptStats[pt].pending++;
    }
    const topPTs = Object.entries(ptStats)
      .map(([pt, stats]) => ({ pt, total: stats.yes + stats.no + stats.pending, ...stats }))
      .sort((a,b) => b.total - a.total)
      .slice(0, 10);
    
    console.log('📊 PT Status Chart Data:', { 
      totalPTs: Object.keys(ptStats).length, 
      topPTs: topPTs.length, 
      sample: topPTs[0],
      note: 'Excluding "Direct Landing Page" - it is a Source, not a PT'
    });
    
    // Handle empty data for PT chart - ensure canvas exists
    const ptCanvasElement = document.getElementById('ptStatusChart');
    if(topPTs.length === 0){
      // Clear existing chart if it exists
      if(charts['ptStatusChart']){
        charts['ptStatusChart'].destroy();
        delete charts['ptStatusChart'];
      }
      
      // Ensure canvas element exists (recreate if destroyed)
      if(!ptCanvasElement){
        const parent = document.querySelector('[data-chart="ptStatusChart"]');
        if(parent){
          parent.innerHTML = '<h3>📊 Submission Status by PT (Top 10)</h3><canvas id="ptStatusChart" height="280"></canvas>';
        }
      }
      
      // Create empty chart with message
      const ctx = document.getElementById('ptStatusChart');
      if(ctx){
        const emptyCtx = ctx.getContext('2d');
        if(charts['ptStatusChart']) charts['ptStatusChart'].destroy();
        charts['ptStatusChart'] = new Chart(emptyCtx, {
          type: 'bar',
          data: {
            labels: [],
            datasets: []
          },
          options: {
            plugins: {
              legend: { display: false },
              tooltip: { enabled: false }
            },
            scales: {
              x: { display: false },
              y: { display: false }
            }
          },
          plugins: [{
            id: 'emptyMessage',
            afterDraw: (chart) => {
              const ctx = chart.ctx;
              const width = chart.width;
              const height = chart.height;
              ctx.save();
              ctx.textAlign = 'center';
              ctx.textBaseline = 'middle';
              ctx.font = '14px Outfit';
              ctx.fillStyle = '#6b7280';
              ctx.fillText('📊 No PT data available with current filters', width / 2, height / 2 - 10);
              ctx.font = '12px Outfit';
              ctx.fillText('Try adjusting your filters', width / 2, height / 2 + 15);
              ctx.restore();
            }
          }]
        });
      }
    } else {
      // Ensure canvas exists before rendering chart
      if(!ptCanvasElement){
        const parent = document.querySelector('[data-chart="ptStatusChart"]');
        if(parent){
          parent.innerHTML = '<h3>📊 Submission Status by PT (Top 10)</h3><canvas id="ptStatusChart" height="280"></canvas>';
        }
      }
      
      makeChart('ptStatusChart','bar',{
      labels: topPTs.map(p => p.pt),
      datasets:[
        { 
          label: 'Approved', 
          data: topPTs.map(p => p.yes), 
          backgroundColor:'#10b981',
          borderRadius: 10,
          barThickness: 22
        },
        { 
          label: 'Pending', 
          data: topPTs.map(p => p.pending), 
          backgroundColor:'#8b5cf6',
          borderRadius: 10,
          barThickness: 22
        },
        { 
          label: 'Rejected', 
          data: topPTs.map(p => p.no), 
          backgroundColor:'#f59e0b',
          borderRadius: 10,
          barThickness: 22
        }
      ]
    },{ 
      plugins: { 
        legend: { 
          display: true, 
          position: 'top', 
          labels: { 
            color: '#1f2937', 
            padding: 14, 
            font: { size: 12, weight: '700', family: 'Outfit' }, 
            usePointStyle: true, 
            pointStyle: 'circle' 
          } 
        } 
      }, 
      scales: { 
        x: { 
          ticks: { 
            color: '#1f2937', 
            maxRotation: 45, 
            minRotation: 25, 
            font: { size: 11, weight: '700', family: 'Outfit' } 
          }, 
          grid: { display: false } 
        }, 
        y: { 
          ticks: { color: '#6b7280', font: { weight: '700', family: 'Space Grotesk' } }, 
          grid: { color: '#e5e7eb' } 
        } 
      }
    });
    }

    // NEW: Participation Share by Source
    const sourceStats = {};
    for(const r of rows){
      const src = trim(r.Source||'');
      if(!src) continue;
      sourceStats[src] = (sourceStats[src]||0) + 1;
    }
    const sourceData = Object.entries(sourceStats).sort((a,b) => b[1] - a[1]);
    
    console.log('📱 Source Chart Data:', { totalSources: Object.keys(sourceStats).length, sourceData: sourceData });
    
    // Handle empty data for Source chart - ensure canvas exists
    const sourceCanvasElement = document.getElementById('sourceChart');
    if(sourceData.length === 0){
      // Clear existing chart if it exists
      if(charts['sourceChart']){
        charts['sourceChart'].destroy();
        delete charts['sourceChart'];
      }
      
      // Ensure canvas element exists (recreate if destroyed)
      if(!sourceCanvasElement){
        const parent = document.querySelector('[data-chart="sourceChart"]');
        if(parent){
          parent.innerHTML = '<h3>📱 Participation Share by Source</h3><canvas id="sourceChart" height="280"></canvas>';
        }
      }
      
      // Create empty chart with message
      const ctx = document.getElementById('sourceChart');
      if(ctx){
        const emptyCtx = ctx.getContext('2d');
        if(charts['sourceChart']) charts['sourceChart'].destroy();
        charts['sourceChart'] = new Chart(emptyCtx, {
          type: 'doughnut',
          data: {
            labels: [],
            datasets: []
          },
          options: {
            plugins: {
              legend: { display: false },
              tooltip: { enabled: false }
            }
          },
          plugins: [{
            id: 'emptyMessage',
            afterDraw: (chart) => {
              const ctx = chart.ctx;
              const width = chart.width;
              const height = chart.height;
              ctx.save();
              ctx.textAlign = 'center';
              ctx.textBaseline = 'middle';
              ctx.font = '14px Outfit';
              ctx.fillStyle = '#6b7280';
              ctx.fillText('📱 No Source data with current filters', width / 2, height / 2 - 10);
              ctx.font = '12px Outfit';
              ctx.fillText('Try adjusting your filters', width / 2, height / 2 + 15);
              ctx.restore();
            }
          }]
        });
      }
    } else {
      // Ensure canvas exists before rendering chart
      if(!sourceCanvasElement){
        const parent = document.querySelector('[data-chart="sourceChart"]');
        if(parent){
          parent.innerHTML = '<h3>📱 Participation Share by Source</h3><canvas id="sourceChart" height="280"></canvas>';
        }
      }
      makeChart('sourceChart','doughnut',{
      labels: sourceData.map(s => s[0]),
      datasets:[{ 
        data: sourceData.map(s => s[1]), 
        backgroundColor:['#6366f1','#ec4899','#10b981','#f59e0b','#8b5cf6'],
        borderWidth: 4,
        borderColor: '#fff',
        hoverOffset: 10
      }]
    },{
      plugins:{
        legend:{ 
          display:true,
          position:'bottom',
          labels:{ 
            color:'#1f2937', 
            padding:15, 
            font:{size:13,weight:'800',family:'Outfit'},
            usePointStyle:true,
            pointStyle:'circle',
            generateLabels: function(chart) {
              const data = chart.data;
              if (data.labels.length && data.datasets.length) {
                return data.labels.map((label, i) => {
                  const value = data.datasets[0].data[i];
                  const total = data.datasets[0].data.reduce((a, b) => a + b, 0);
                  const percent = ((value / total) * 100).toFixed(1);
                  return {
                    text: `${label}: ${value.toLocaleString()} (${percent}%)`,
                    fillStyle: data.datasets[0].backgroundColor[i],
                    hidden: false,
                    index: i
                  };
                });
              }
              return [];
            }
          }
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              const label = context.label || '';
              const value = context.parsed || 0;
              const total = context.dataset.data.reduce((a, b) => a + b, 0);
              const percent = ((value / total) * 100).toFixed(1);
              return `${label}: ${value.toLocaleString()} (${percent}%)`;
            }
          }
        }
      },
      cutout:'65%'
    });
    }
  }

  // India Map
  let indiaMap = null;
  let mapLayer = null;

  const stateCoordinates = {
    'Andhra Pradesh': [15.9129, 79.7400],'Arunachal Pradesh': [28.2180, 94.7278],
    'Assam': [26.2006, 92.9376],'Bihar': [25.0961, 85.3131],'Chhattisgarh': [21.2787, 81.8661],
    'Goa': [15.2993, 74.1240],'Gujarat': [22.2587, 71.1924],'Haryana': [29.0588, 76.0856],
    'Himachal Pradesh': [31.1048, 77.1734],'Jharkhand': [23.6102, 85.2799],
    'Karnataka': [15.3173, 75.7139],'Kerala': [10.8505, 76.2711],'Madhya Pradesh': [22.9734, 78.6569],
    'Maharashtra': [19.7515, 75.7139],'Manipur': [24.6637, 93.9063],'Meghalaya': [25.4670, 91.3662],
    'Mizoram': [23.1645, 92.9376],'Nagaland': [26.1584, 94.5624],'Odisha': [20.9517, 85.0985],
    'Punjab': [31.1471, 75.3412],'Rajasthan': [27.0238, 74.2179],'Sikkim': [27.5330, 88.5122],
    'Tamil Nadu': [11.1271, 78.6569],'Telangana': [18.1124, 79.0193],'Tripura': [23.9408, 91.9882],
    'Uttar Pradesh': [26.8467, 80.9462],'Uttarakhand': [30.0668, 79.0193],
    'West Bengal': [22.9868, 87.8550],'Andaman and Nicobar Islands': [11.7401, 92.6586],
    'Chandigarh': [30.7333, 76.7794],'Dadra and Nagar Haveli': [20.1809, 73.0169],
    'Daman and Diu': [20.4283, 72.8397],'Lakshadweep': [10.5667, 72.6417],
    'Delhi': [28.7041, 77.1025],'Puducherry': [11.9416, 79.8083],
    'Jammu and Kashmir': [33.7782, 76.5762],'Ladakh': [34.1526, 77.5771]
  };

  function getMarkerLevel(approved) {
    if (approved >= 1000) return 1;
    if (approved >= 500) return 2;
    if (approved >= 250) return 3;
    if (approved >= 100) return 4;
    return 5;
  }

  function getMarkerIcon(state, approved) {
    const level = getMarkerLevel(approved);
    const shortName = state.length > 12 ? state.substring(0, 10) + '.' : state;
    
    return L.divIcon({
      className: 'state-marker-pin',
      html: `
        <div class="marker-ripple"></div>
        <div class="state-marker-inner state-marker-level-${level}">
          <div class="state-marker-name">${shortName}</div>
          <div class="state-marker-count">
            <span>✓</span>
            <span>${approved.toLocaleString()}</span>
          </div>
        </div>
      `,
      iconSize: [null, null],
      iconAnchor: [30, 30]
    });
  }

  function getApprovalRate(approved, total) {
    if (total === 0) return 0;
    return (approved / total * 100).toFixed(1);
  }

  function initMap() {
    if (indiaMap) return;
    indiaMap = L.map('indiaMap', { center: [22.5, 82.5], zoom: 5, minZoom: 4, maxZoom: 8, zoomControl: true });
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OpenStreetMap', maxZoom: 19 }).addTo(indiaMap);
  }

  function renderIndiaMap(rows) {
    if (!indiaMap) { initMap(); }
    if (mapLayer) { indiaMap.removeLayer(mapLayer); }

    const stateData = new Map();
    for (const r of rows) {
      const st = trim(r.State);
      if (!st) continue;
      if (!stateData.has(st)) stateData.set(st, { total: 0, approved: 0, rejected: 0, pending: 0 });
      const data = stateData.get(st);
      data.total++;
      const status = trim(r['Submission Status']).toLowerCase();
      if (status === 'yes') data.approved++;
      else if (status === 'no') data.rejected++;
      else if (status === 'pending') data.pending++;
    }
    
    mapLayer = L.layerGroup();
    
    // Track totals for stats card
    let totalApproved = 0, totalPending = 0, totalRejected = 0;

    for (const [state, coords] of Object.entries(stateCoordinates)) {
      const data = stateData.get(state);
      if (!data || data.approved === 0) continue;

      totalApproved += data.approved;
      totalPending += data.pending;
      totalRejected += data.rejected;

      const approvalRate = getApprovalRate(data.approved, data.total);
      const marker = L.marker(coords, { icon: getMarkerIcon(state, data.approved) });

      const popupContent = `
        <div class="map-popup-state">📍 ${state}</div>
        <div class="map-popup-row"><span class="map-popup-label">✅ Approved</span><span class="map-popup-value map-popup-success">${data.approved.toLocaleString()}</span></div>
        <div class="map-popup-row"><span class="map-popup-label">⏳ Pending</span><span class="map-popup-value map-popup-pending">${data.pending.toLocaleString()}</span></div>
        <div class="map-popup-row"><span class="map-popup-label">❌ Rejected</span><span class="map-popup-value map-popup-rejected">${data.rejected.toLocaleString()}</span></div>
        <div class="map-popup-row" style="border-top:2px solid var(--ring);margin-top:10px;padding-top:10px"><span class="map-popup-label">📊 Total Scans</span><span class="map-popup-value">${data.total.toLocaleString()}</span></div>
        <div class="map-popup-row"><span class="map-popup-label">🎯 Approval Rate</span><span class="map-popup-value map-popup-success">${approvalRate}%</span></div>
      `;

      marker.bindPopup(popupContent, { closeButton: true, maxWidth: 340 });
      marker.on('click', () => { FILTERS.state = state; selState.value = state; render(); });
      marker.addTo(mapLayer);
    }

    mapLayer.addTo(indiaMap);
    
    // Update map stats card - NEW
    document.getElementById('mapActiveStates').textContent = stateData.size;
    document.getElementById('mapApproved').textContent = totalApproved.toLocaleString();
    document.getElementById('mapPending').textContent = totalPending.toLocaleString();
    document.getElementById('mapRejected').textContent = totalRejected.toLocaleString();
    
    setTimeout(() => { indiaMap.fitBounds([[8, 68],[37, 97]]); }, 100);
  }

  // Smart cascading filter population - updates all filters based on current selections
  function populateFilters(rows, refData = [], preserveFilters = false){
    // Apply current filters to get filtered dataset
    const filteredRows = preserveFilters ? applyFilters(rows) : rows;
    
    // For reference data, apply relevant filters
    let filteredRefData = refData;
    if(preserveFilters && refData.length > 0){
      filteredRefData = refData.filter(r => {
        // Apply date range filter if present
        if(FILTERS.dateFrom || FILTERS.dateTo){
          const refDate = parseReferenceDate(trim(r['Date Processed'] || ''));
          if(FILTERS.dateFrom && refDate < FILTERS.dateFrom) return false;
          if(FILTERS.dateTo && refDate > FILTERS.dateTo) return false;
        }
        
        if(FILTERS.state && trim(r.State) !== FILTERS.state) return false;
        if(FILTERS.zone && trim(r.ZONE) !== FILTERS.zone) return false;
        if(FILTERS.pt && trim(r.Name) !== FILTERS.pt) return false;
        if(FILTERS.hq && trim(r.HQ) !== FILTERS.hq) return false;
        return true;
      });
    }
    
    // Extract unique values from filtered data
    const states = uniqSorted(filteredRows.map(r=>trim(r.State)));
    const dists  = uniqSorted(filteredRows.map(r=>trim(r.District)));
    const rets   = uniqSorted(filteredRows.map(r=>trim(r['Retailer Name'])));
    const products = uniqSorted(filteredRows.flatMap(r=>[...parseProducts(r['Cart Items']).keys()]));
    const unitsAll = uniqSorted(filteredRows.flatMap(r=>parseCartItems(r['Cart Items']).map(it=>it.unit).filter(Boolean)));
    const statuses = ['','Yes','No','Pending'];
    const sources = uniqSorted(filteredRows.map(r=>trim(r.Source||'')).filter(Boolean));
    
    // Combine PT names from both filtered datasets
    const ptsFromData = filteredRows.map(r=>trim(r.PT||'')).filter(Boolean);
    const ptsFromRef = filteredRefData.map(r=>trim(r.Name||'')).filter(Boolean);
    const pts = uniqSorted([...ptsFromData, ...ptsFromRef]);
    
    // Combine Zone values from both filtered datasets (data.csv has "Zone", reference.csv has "ZONE")
    const zonesFromData = filteredRows.map(r=>trim(r.Zone||'')).filter(Boolean);
    const zonesFromRef = filteredRefData.map(r=>trim(r.ZONE||'')).filter(Boolean);
    const zones = uniqSorted([...zonesFromData, ...zonesFromRef]);
    
    // HQ filter is unique to reference.csv
    const hqs = uniqSorted(filteredRefData.map(r=>trim(r.HQ||'')).filter(Boolean));

    function fill(sel, items, currentValue){ 
      const prevValue = currentValue !== undefined ? currentValue : sel.value;
      sel.innerHTML = ''; 
      const opt0 = document.createElement('option'); 
      opt0.value=''; 
      // Show count of available options
      opt0.textContent = items.length > 0 ? `All (${items.length})` : 'All'; 
      sel.appendChild(opt0); 
      
      let valueStillExists = false;
      for(const v of items){ 
        const o=document.createElement('option'); 
        o.value=v; 
        o.textContent=v; 
        sel.appendChild(o);
        if(v === prevValue) valueStillExists = true;
      }
      
      // Restore previous value if it still exists in filtered options
      if(preserveFilters && valueStillExists){
        sel.value = prevValue;
      } else if(preserveFilters && !valueStillExists && prevValue){
        // Value no longer valid, clear it from FILTERS
        return null; // Indicates filter should be cleared
      }
      
      return valueStillExists ? prevValue : '';
    }

    // Fill all dropdowns and track if any filters need to be cleared
    const stateValid = fill(selState, states, FILTERS.state);
    const distValid = fill(selDistrict, dists, FILTERS.district);
    const retValid = fill(selRetailer, rets, FILTERS.retailer);
    const prodValid = fill(selProduct, products, FILTERS.product);
    const unitValid = fill(selUnit, unitsAll, FILTERS.unit);
    fill(selStatus, statuses, FILTERS.status);
    const sourceValid = fill(selSource, sources, FILTERS.source);
    const ptValid = fill(selPT, pts, FILTERS.pt);
    const zoneValid = fill(selZone, zones, FILTERS.zone);
    const hqValid = fill(selHQ, hqs, FILTERS.hq);
    
    // Clear filters that are no longer valid
    if(preserveFilters){
      if(stateValid === null) FILTERS.state = '';
      if(distValid === null) FILTERS.district = '';
      if(retValid === null) FILTERS.retailer = '';
      if(prodValid === null) FILTERS.product = '';
      if(unitValid === null) FILTERS.unit = '';
      if(sourceValid === null) FILTERS.source = '';
      if(ptValid === null) FILTERS.pt = '';
      if(zoneValid === null) FILTERS.zone = '';
      if(hqValid === null) FILTERS.hq = '';
    }
  }

  function attachFilterHandlers(){
    // Date filters
    selDateFrom.onchange = ()=>{ 
      FILTERS.dateFrom = selDateFrom.value; 
      populateFilters(RAW, REFERENCE_DATA, true);
      render(); 
    };
    selDateTo.onchange = ()=>{ 
      FILTERS.dateTo = selDateTo.value; 
      populateFilters(RAW, REFERENCE_DATA, true);
      render(); 
    };

    // All other filters trigger cascading updates
    selState.onchange = ()=>{
      FILTERS.state = selState.value;
      populateFilters(RAW, REFERENCE_DATA, true);
      render();
    };

    selDistrict.onchange = ()=>{
      FILTERS.district = selDistrict.value;
      populateFilters(RAW, REFERENCE_DATA, true);
      render();
    };

    selRetailer.onchange = ()=>{ 
      FILTERS.retailer = selRetailer.value; 
      populateFilters(RAW, REFERENCE_DATA, true);
      render(); 
    };

    selProduct.onchange = ()=>{
      FILTERS.product = selProduct.value;
      populateFilters(RAW, REFERENCE_DATA, true);
      render();
    };

    selUnit.onchange = ()=>{ 
      FILTERS.unit = selUnit.value; 
      populateFilters(RAW, REFERENCE_DATA, true);
      render(); 
    };
    
    selStatus.onchange = ()=>{ 
      FILTERS.status = selStatus.value; 
      populateFilters(RAW, REFERENCE_DATA, true);
      render(); 
    };
    
    selSource.onchange = ()=>{ 
      FILTERS.source = selSource.value; 
      populateFilters(RAW, REFERENCE_DATA, true);
      render(); 
    };
    
    selPT.onchange = ()=>{ 
      FILTERS.pt = selPT.value; 
      populateFilters(RAW, REFERENCE_DATA, true);
      render(); 
    };
    
    selZone.onchange = ()=>{ 
      FILTERS.zone = selZone.value; 
      populateFilters(RAW, REFERENCE_DATA, true);
      render(); 
    };
    
    selHQ.onchange = ()=>{ 
      FILTERS.hq = selHQ.value; 
      populateFilters(RAW, REFERENCE_DATA, true);
      render(); 
    };
  }

  function render(){
    const rows = applyFilters(RAW);
    updateKpis(rows);
    renderStatesTable(rows);
    renderIndiaMap(rows);
    requestAnimationFrame(()=> renderCharts(rows));
  }

  function normalizeRow(r){
    return {
      'User ID': r['User ID']||r['UserID']||r['id']||'',
      'Phone Number': r['Phone Number']||r['Phone']||r['phone']||'',
      'First Name': r['First Name']||r['FirstName']||'',
      'Last Name': r['Last Name']||r['LastName']||'',
      'District': r['District']||'',
      'State': r['State']||'',
      'Language': r['Language']||'',
      'Pin Code': r['Pin Code']||r['Pincode']||'',
      'QR Code': r['QR Code']||'',
      'Land Acreage': r['Land Acreage']||r['Land']||'',
      'Crop Name': r['Crop Name']||'',
      'Scan Date': r['Scan Date']||r['Date']||'',
      'RIN': r['RIN']||'',
      'Retailer Name': r['Retailer Name']||r['Retailer']||'',
      'Cart Items': r['Cart Items']||'',
      'Coupon Code': r['Coupon Code']||'',
      'Submission Status': r['Submission Status']||r['Approved Status']||'',
      'Source': r['Source']||'',
      'PT': r['PT']||'',
      'Zone': r['Zone']||''
    };
  }

  // Load both CSV files in parallel
  let csvLoaded = false;
  let referenceLoaded = false;

  function checkBothLoaded(){
    if(csvLoaded && referenceLoaded){
      populateFilters(RAW, REFERENCE_DATA);
      attachFilterHandlers();
      render();
      console.log('✅ Both CSV files loaded successfully!');
    }
  }

  // Load main data.csv
  Papa.parse(CSV_URL, {
    download: true,
    header: true,
    skipEmptyLines: true,
    dynamicTyping: false,
    complete: (res)=>{
      RAW = res.data.map(normalizeRow);
      
      // Debug: Check if new columns exist
      if(RAW.length > 0){
        const firstRow = RAW[0];
        console.log('✅ data.csv Columns Found:', Object.keys(firstRow));
        console.log('📊 Data Check:', {
          totalRows: RAW.length,
          hasSource: 'Source' in firstRow,
          hasPT: 'PT' in firstRow,
          hasZone: 'Zone' in firstRow
        });
      }
      
      csvLoaded = true;
      checkBothLoaded();
    },
    error: (err)=>{
      console.error('CSV load error', err);
      alert('Failed to load data.csv. Ensure the file exists at '+CSV_URL);
    }
  });

  // Load reference.csv for PT/Missed Calls data
  Papa.parse(REFERENCE_CSV_URL, {
    download: true,
    header: true,
    skipEmptyLines: true,
    dynamicTyping: false,
    complete: (res)=>{
      // Separate Grand Total row from actual PT data
      const allData = res.data;
      REFERENCE_DATA = allData.filter(r => {
        const name = trim(r.Name || '');
        // Exclude Grand Total row from PT data
        return name && !name.toLowerCase().includes('grand total');
      });
      
      // Find and store Grand Total row separately
      const grandTotalRow = allData.find(r => {
        const name = trim(r.Name || '');
        return name && name.toLowerCase().includes('grand total');
      });
      
      if(grandTotalRow){
        REFERENCE_GRAND_TOTAL = {
          total: Number(grandTotalRow['Total Missed Calls']) || 0,
          unique: Number(grandTotalRow['Total Unique Missed Calls']) || 0
        };
      }
      
      if(REFERENCE_DATA.length > 0){
        const firstRow = REFERENCE_DATA[0];
        const hasDateColumn = 'Date Processed' in firstRow;
        
        console.log('✅ reference.csv loaded:', {
          totalPTs: REFERENCE_DATA.length,
          columns: Object.keys(firstRow),
          sample: firstRow,
          hasGrandTotal: !!REFERENCE_GRAND_TOTAL,
          hasDateColumn: hasDateColumn
        });
        
        // Test date parsing if Date Processed column exists
        if(hasDateColumn && firstRow['Date Processed']){
          const sampleDate = firstRow['Date Processed'];
          const parsedDate = parseReferenceDate(sampleDate);
          console.log('📅 Date Parsing Test:', {
            originalFormat: sampleDate,
            parsedToYYYYMMDD: parsedDate,
            willWorkWithFilters: !!parsedDate
          });
        }
        
        // Calculate totals from PT data (excluding Grand Total)
        let totalMissed = 0, totalUnique = 0;
        for(const r of REFERENCE_DATA){
          totalMissed += Number(r['Total Missed Calls']) || 0;
          totalUnique += Number(r['Total Unique Missed Calls']) || 0;
        }
        
        console.log('📞 Missed Calls Data:', {
          ptCount: REFERENCE_DATA.length,
          calculatedTotal: totalMissed.toLocaleString(),
          calculatedUnique: totalUnique.toLocaleString(),
          grandTotalRow: REFERENCE_GRAND_TOTAL ? `${REFERENCE_GRAND_TOTAL.total.toLocaleString()} total, ${REFERENCE_GRAND_TOTAL.unique.toLocaleString()} unique` : 'Not found',
          states: [...new Set(REFERENCE_DATA.map(r=>r.State))].length,
          dateFilterSupport: hasDateColumn ? 'Enabled ✅' : 'Disabled (no Date Processed column)'
        });
      }
      
      referenceLoaded = true;
      checkBothLoaded();
    },
    error: (err)=>{
      console.error('Reference CSV load error', err);
      alert('Failed to load reference.csv. Ensure the file exists at '+REFERENCE_CSV_URL);
    }
  });
</script>

<!-- Theme Auto-Sync Script -->
<script>
  // Auto-apply theme from theme-controller
  function applyThemeFromController() {
    const savedTheme = localStorage.getItem('dashboardThemeActive');
    if (savedTheme) {
      try {
        const theme = JSON.parse(savedTheme);
        const root = document.documentElement;
        
        // Apply all CSS variables
        if (theme.bg) root.style.setProperty('--bg', theme.bg);
        if (theme.panel) root.style.setProperty('--panel', theme.panel);
        if (theme.card) root.style.setProperty('--card', theme.card);
        if (theme.cardHover) root.style.setProperty('--card-hover', theme.cardHover);
        if (theme.muted) root.style.setProperty('--muted', theme.muted);
        if (theme.text) root.style.setProperty('--text', theme.text);
        if (theme.acc1) root.style.setProperty('--acc1', theme.acc1);
        if (theme.acc2) root.style.setProperty('--acc2', theme.acc2);
        if (theme.acc3) root.style.setProperty('--acc3', theme.acc3);
        if (theme.acc4) root.style.setProperty('--acc4', theme.acc4);
        if (theme.acc5) root.style.setProperty('--acc5', theme.acc5);
        if (theme.ring) root.style.setProperty('--ring', theme.ring);
        if (theme.border) root.style.setProperty('--border', theme.border);
        if (theme.shadow) root.style.setProperty('--shadow', theme.shadow);
        if (theme.shadowLg) root.style.setProperty('--shadow-lg', theme.shadowLg);
        
        // Apply fonts
        if (theme.fontBody) document.body.style.fontFamily = theme.fontBody;
        if (theme.fontHeadings) {
          document.querySelectorAll('.title, .kpi-value').forEach(el => {
            el.style.fontFamily = theme.fontHeadings;
          });
        }
        
        console.log('✅ Theme applied from Theme Controller');
      } catch (e) {
        console.error('Failed to apply theme:', e);
      }
    }
  }
  
  // Apply theme on page load
  applyThemeFromController();
  
  // Listen for theme updates from theme-controller (if both pages are open)
  window.addEventListener('storage', function(e) {
    if (e.key === 'dashboardThemeActive') {
      applyThemeFromController();
      console.log('🎨 Theme updated live!');
    }
  });
</script>

</body>
</html>
