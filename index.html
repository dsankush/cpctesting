<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Coromandel CPC — Campaign Analytics Hub</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800;900&family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

  <style>
    :root{
      --primary:#00d4ff;
      --secondary:#ff6b9d;
      --accent:#7c3aed;
      --success:#00e676;
      --warning:#ffc107;
      --danger:#ff5252;
      --dark:#0f0f23;
      --darker:#08081a;
      --light:#ffffff;
      --muted:#94a3b8;
      --border:rgba(255,255,255,0.08);
      --glass:rgba(255,255,255,0.05);
      --glow:rgba(0,212,255,0.3);
    }
    
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%;overflow-x:hidden}
    
    body{
      font-family:'Poppins',sans-serif;
      background:#0f0f23;
      color:#ffffff;
      position:relative;
      overflow-x:hidden;
    }
    
    /* Animated Background */
    body::before{
      content:'';
      position:fixed;
      top:0;left:0;right:0;bottom:0;
      background:
        radial-gradient(circle at 20% 50%, rgba(0,212,255,0.15) 0%, transparent 50%),
        radial-gradient(circle at 80% 80%, rgba(255,107,157,0.15) 0%, transparent 50%),
        radial-gradient(circle at 40% 20%, rgba(124,58,237,0.15) 0%, transparent 50%);
      animation:bgFloat 20s ease-in-out infinite;
      z-index:0;
    }
    
    @keyframes bgFloat{
      0%,100%{transform:translate(0,0) scale(1)}
      33%{transform:translate(50px,-50px) scale(1.1)}
      66%{transform:translate(-50px,50px) scale(0.9)}
    }
    
    .app{
      position:relative;
      z-index:1;
      display:grid;
      grid-template-rows:auto 1fr auto;
      min-height:100vh;
    }
    
    /* Header with Glass Effect */
    header{
      position:sticky;
      top:0;
      z-index:100;
      backdrop-filter:saturate(180%) blur(20px);
      background:rgba(15,15,35,0.8);
      border-bottom:1px solid var(--border);
      box-shadow:0 20px 60px rgba(0,0,0,0.4);
    }
    
    .bar{
      display:flex;
      align-items:center;
      gap:24px;
      padding:20px 48px;
      flex-wrap:wrap;
    }
    
    .logo{
      display:flex;
      align-items:center;
      gap:16px;
      font-family:'Space Grotesk',sans-serif;
      font-size:24px;
      font-weight:700;
      background:linear-gradient(135deg,var(--primary),var(--secondary));
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      background-clip:text;
      position:relative;
    }
    
    .logo::before{
      content:'';
      width:40px;
      height:40px;
      background:linear-gradient(135deg,var(--primary),var(--secondary));
      border-radius:12px;
      animation:spin 3s linear infinite;
      box-shadow:0 0 30px rgba(0,212,255,0.5);
    }
    
    @keyframes spin{
      0%{transform:rotate(0deg) scale(1)}
      50%{transform:rotate(180deg) scale(1.1)}
      100%{transform:rotate(360deg) scale(1)}
    }
    
    .header-actions{
      margin-left:auto;
      display:flex;
      gap:12px;
      align-items:center;
    }
    
    .btn{
      padding:12px 28px;
      border-radius:50px;
      border:none;
      background:linear-gradient(135deg,var(--primary),var(--accent));
      color:white;
      font-weight:600;
      font-size:14px;
      cursor:pointer;
      transition:all 0.3s cubic-bezier(0.4,0,0.2,1);
      box-shadow:0 8px 24px rgba(0,212,255,0.3);
      position:relative;
      overflow:hidden;
    }
    
    .btn::before{
      content:'';
      position:absolute;
      top:50%;
      left:50%;
      width:0;
      height:0;
      border-radius:50%;
      background:rgba(255,255,255,0.2);
      transform:translate(-50%,-50%);
      transition:width 0.6s,height 0.6s;
    }
    
    .btn:hover::before{
      width:300px;
      height:300px;
    }
    
    .btn:hover{
      transform:translateY(-2px);
      box-shadow:0 12px 40px rgba(0,212,255,0.5);
    }
    
    .btn-logout{
      background:linear-gradient(135deg,var(--danger),#d32f2f);
      box-shadow:0 8px 24px rgba(255,82,82,0.3);
    }
    
    .btn-logout:hover{
      box-shadow:0 12px 40px rgba(255,82,82,0.5);
    }
    
    /* Main Content */
    .main{
      padding:40px 48px;
      display:flex;
      flex-direction:column;
      gap:32px;
    }
    
    /* Glass Morphism Cards */
    .glass-card{
      background:rgba(255,255,255,0.03);
      backdrop-filter:blur(20px);
      border:1px solid rgba(255,255,255,0.08);
      border-radius:24px;
      padding:32px;
      box-shadow:0 8px 32px rgba(0,0,0,0.3);
      transition:all 0.4s cubic-bezier(0.4,0,0.2,1);
      position:relative;
      overflow:hidden;
    }
    
    .glass-card::before{
      content:'';
      position:absolute;
      top:0;
      left:0;
      right:0;
      height:2px;
      background:linear-gradient(90deg,var(--primary),var(--secondary),var(--accent));
      opacity:0;
      transition:opacity 0.3s;
    }
    
    .glass-card:hover{
      transform:translateY(-4px);
      border-color:rgba(0,212,255,0.3);
      box-shadow:0 20px 60px rgba(0,212,255,0.2);
    }
    
    .glass-card:hover::before{
      opacity:1;
    }
    
    /* Filters */
    .filters{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
      gap:16px;
      align-items:end;
    }
    
    .filter-group{
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    
    .filter-label{
      font-size:12px;
      font-weight:600;
      text-transform:uppercase;
      letter-spacing:1px;
      color:var(--muted);
      display:flex;
      align-items:center;
      gap:6px;
    }
    
    .filter-input,.filter-select{
      padding:14px 16px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,0.1);
      background:rgba(255,255,255,0.05);
      color:white;
      font-size:14px;
      font-weight:500;
      transition:all 0.3s;
      outline:none;
    }
    
    .filter-input:hover,.filter-select:hover{
      border-color:var(--primary);
      background:rgba(0,212,255,0.05);
    }
    
    .filter-input:focus,.filter-select:focus{
      border-color:var(--primary);
      background:rgba(0,212,255,0.1);
      box-shadow:0 0 0 3px rgba(0,212,255,0.1);
    }
    
    .filter-select option{
      background:#1a1a2e;
      color:white;
    }
    
    /* KPI Section */
    .kpi-section{
      display:grid;
      grid-template-columns:300px 1fr;
      gap:32px;
      align-items:center;
    }
    
    .kpi-hero{
      width:300px;
      height:300px;
      border-radius:50%;
      background:linear-gradient(135deg,rgba(0,212,255,0.1),rgba(124,58,237,0.1));
      border:3px solid;
      border-image:linear-gradient(135deg,var(--primary),var(--accent)) 1;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      position:relative;
      box-shadow:0 0 60px rgba(0,212,255,0.3);
      animation:pulse 3s ease-in-out infinite;
    }
    
    @keyframes pulse{
      0%,100%{box-shadow:0 0 60px rgba(0,212,255,0.3)}
      50%{box-shadow:0 0 80px rgba(0,212,255,0.5)}
    }
    
    .kpi-hero-label{
      font-size:14px;
      font-weight:700;
      text-transform:uppercase;
      letter-spacing:2px;
      color:var(--muted);
      margin-bottom:12px;
    }
    
    .kpi-hero-value{
      font-size:72px;
      font-weight:900;
      font-family:'Space Grotesk',sans-serif;
      background:linear-gradient(135deg,var(--primary),var(--secondary));
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      background-clip:text;
      line-height:1;
    }
    
    .kpi-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
      gap:20px;
    }
    
    .kpi-card{
      background:linear-gradient(135deg,rgba(255,255,255,0.05),rgba(255,255,255,0.02));
      border:1px solid rgba(255,255,255,0.1);
      border-radius:20px;
      padding:28px;
      text-align:center;
      transition:all 0.3s;
      position:relative;
      overflow:hidden;
    }
    
    .kpi-card::before{
      content:'';
      position:absolute;
      top:0;
      left:0;
      right:0;
      height:3px;
      background:linear-gradient(90deg,transparent,var(--kpi-color),transparent);
      opacity:0;
      transition:opacity 0.3s;
    }
    
    .kpi-card:hover{
      transform:translateY(-8px) scale(1.02);
      box-shadow:0 20px 40px rgba(0,0,0,0.4);
      border-color:var(--kpi-color);
    }
    
    .kpi-card:hover::before{
      opacity:1;
    }
    
    .kpi-card:nth-child(1){--kpi-color:var(--success)}
    .kpi-card:nth-child(2){--kpi-color:var(--danger)}
    .kpi-card:nth-child(3){--kpi-color:var(--accent)}
    .kpi-card:nth-child(4){--kpi-color:var(--primary)}
    .kpi-card:nth-child(5){--kpi-color:var(--secondary)}
    
    .kpi-label{
      font-size:12px;
      font-weight:700;
      text-transform:uppercase;
      letter-spacing:1px;
      color:var(--muted);
      margin-bottom:16px;
    }
    
    .kpi-value{
      font-size:48px;
      font-weight:900;
      font-family:'Space Grotesk',sans-serif;
      color:var(--kpi-color);
      margin-bottom:12px;
      line-height:1;
    }
    
    .kpi-subtitle{
      font-size:13px;
      font-weight:600;
      color:var(--muted);
    }
    
    /* Content Grid */
    .content-grid{
      display:grid;
      grid-template-columns:repeat(12,1fr);
      gap:28px;
    }
    
    .span-4{grid-column:span 4}
    .span-6{grid-column:span 6}
    .span-8{grid-column:span 8}
    .span-12{grid-column:span 12}
    
    .card-title{
      font-size:16px;
      font-weight:700;
      text-transform:uppercase;
      letter-spacing:1.5px;
      color:var(--primary);
      margin-bottom:24px;
      display:flex;
      align-items:center;
      gap:10px;
    }
    
    /* India Map - Smart Professional Design */
    .map-container{
      position:relative;
      height:800px;
      border-radius:24px;
      overflow:hidden;
      border:1px solid rgba(0,212,255,0.2);
      background:rgba(0,0,0,0.3);
    }
    
    #indiaMap{
      width:100%;
      height:100%;
    }
    
    .leaflet-container{
      background:#0a0a1a;
      font-family:'Poppins',sans-serif;
    }
    
    /* Map Controls Overlay */
    .map-controls{
      position:absolute;
      top:20px;
      left:20px;
      z-index:1000;
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    
    .map-control-btn{
      padding:12px 20px;
      background:rgba(15,15,35,0.95);
      backdrop-filter:blur(10px);
      border:1px solid rgba(0,212,255,0.3);
      border-radius:12px;
      color:white;
      font-size:13px;
      font-weight:600;
      cursor:pointer;
      transition:all 0.3s;
      box-shadow:0 4px 12px rgba(0,0,0,0.3);
    }
    
    .map-control-btn:hover{
      background:rgba(0,212,255,0.2);
      border-color:var(--primary);
      transform:translateX(4px);
    }
    
    /* Map Stats Panel */
    .map-stats{
      position:absolute;
      top:20px;
      right:20px;
      z-index:1000;
      background:rgba(15,15,35,0.95);
      backdrop-filter:blur(20px);
      border:1px solid rgba(0,212,255,0.3);
      border-radius:20px;
      padding:24px;
      min-width:280px;
      box-shadow:0 8px 32px rgba(0,0,0,0.4);
    }
    
    .map-stats-title{
      font-size:14px;
      font-weight:700;
      text-transform:uppercase;
      letter-spacing:1.5px;
      color:var(--primary);
      margin-bottom:16px;
      padding-bottom:12px;
      border-bottom:1px solid rgba(255,255,255,0.1);
    }
    
    .map-stat-item{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:12px 0;
      border-bottom:1px solid rgba(255,255,255,0.05);
    }
    
    .map-stat-label{
      font-size:12px;
      color:var(--muted);
      font-weight:600;
    }
    
    .map-stat-value{
      font-size:18px;
      font-weight:800;
      font-family:'Space Grotesk',sans-serif;
    }
    
    .stat-success{color:var(--success)}
    .stat-danger{color:var(--danger)}
    .stat-warning{color:var(--warning)}
    .stat-primary{color:var(--primary)}
    
    /* Map Legend */
    .map-legend{
      position:absolute;
      bottom:20px;
      right:20px;
      z-index:1000;
      background:rgba(15,15,35,0.95);
      backdrop-filter:blur(20px);
      border:1px solid rgba(0,212,255,0.3);
      border-radius:20px;
      padding:24px;
      box-shadow:0 8px 32px rgba(0,0,0,0.4);
    }
    
    .legend-title{
      font-size:14px;
      font-weight:700;
      text-transform:uppercase;
      letter-spacing:1.5px;
      color:var(--primary);
      margin-bottom:16px;
    }
    
    .legend-item{
      display:flex;
      align-items:center;
      gap:12px;
      margin:10px 0;
      font-size:13px;
      font-weight:600;
    }
    
    .legend-color{
      width:36px;
      height:24px;
      border-radius:8px;
      box-shadow:0 4px 12px rgba(0,0,0,0.3);
    }
    
    /* State Markers */
    .state-marker{
      background:rgba(15,15,35,0.95);
      backdrop-filter:blur(10px);
      border:2px solid;
      border-radius:16px;
      padding:12px 16px;
      box-shadow:0 8px 24px rgba(0,0,0,0.5);
      transition:all 0.3s;
      cursor:pointer;
      min-width:100px;
      text-align:center;
    }
    
    .state-marker:hover{
      transform:translateY(-6px) scale(1.1);
      box-shadow:0 16px 48px rgba(0,212,255,0.6);
    }
    
    .state-name{
      font-size:10px;
      font-weight:700;
      text-transform:uppercase;
      letter-spacing:1px;
      color:var(--muted);
      margin-bottom:6px;
    }
    
    .state-count{
      font-size:22px;
      font-weight:900;
      font-family:'Space Grotesk',sans-serif;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:6px;
    }
    
    .marker-level-1{border-color:#00e676;color:#00e676}
    .marker-level-2{border-color:#00e5ff;color:#00e5ff}
    .marker-level-3{border-color:#ffc107;color:#ffc107}
    .marker-level-4{border-color:#ff9800;color:#ff9800}
    .marker-level-5{border-color:#ff5252;color:#ff5252}
    
    /* Map Popup */
    .leaflet-popup-content-wrapper{
      background:rgba(15,15,35,0.98);
      backdrop-filter:blur(20px);
      border:2px solid var(--primary);
      border-radius:20px;
      box-shadow:0 16px 64px rgba(0,212,255,0.4);
    }
    
    .leaflet-popup-content{
      margin:28px;
      color:white;
      font-size:14px;
    }
    
    .leaflet-popup-tip{
      background:rgba(15,15,35,0.98);
      border:2px solid var(--primary);
    }
    
    .popup-state{
      font-size:22px;
      font-weight:900;
      color:var(--primary);
      margin-bottom:20px;
      padding-bottom:16px;
      border-bottom:2px solid rgba(255,255,255,0.1);
    }
    
    .popup-row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:12px 0;
      border-bottom:1px solid rgba(255,255,255,0.05);
    }
    
    .popup-label{
      font-size:12px;
      color:var(--muted);
      font-weight:600;
      text-transform:uppercase;
      letter-spacing:0.5px;
    }
    
    .popup-value{
      font-size:20px;
      font-weight:800;
      font-family:'Space Grotesk',sans-serif;
    }
    
    /* States Table */
    .states-table{
      overflow-y:auto;
      max-height:400px;
      margin-top:16px;
    }
    
    .state-row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:20px;
    }
    
    .state-info{
      display:flex;
      align-items:center;
      gap:12px;
    }
    
    .state-rank{
      width:32px;
      height:32px;
      border-radius:8px;
      background:linear-gradient(135deg,var(--primary),var(--accent));
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:800;
      font-size:14px;
    }
    
    .state-name-text{
      font-weight:600;
      font-size:15px;
    }
    
    .state-value{
      font-size:20px;
      font-weight:800;
      font-family:'Space Grotesk',sans-serif;
      background:linear-gradient(135deg,var(--primary),var(--secondary));
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      background-clip:text;
    }
    
    .state-bar{
      width:100%;
      height:8px;
      background:rgba(255,255,255,0.05);
      border-radius:4px;
      overflow:hidden;
      margin-top:8px;
    }
    
    .state-bar-fill{
      height:100%;
      border-radius:4px;
      transition:width 0.5s cubic-bezier(0.4,0,0.2,1);
    }
    
    /* Footer */
    .footer{
      padding:24px 48px;
      border-top:1px solid var(--border);
      text-align:center;
      color:var(--muted);
      font-size:14px;
      font-weight:500;
      background:rgba(15,15,35,0.5);
      backdrop-filter:blur(10px);
    }
    
    /* Login */
    .overlay{
      position:fixed;
      inset:0;
      background:rgba(15,15,35,0.95);
      backdrop-filter:blur(20px);
      display:grid;
      place-items:center;
      z-index:200;
    }
    
    .login-card{
      width:min(90vw,480px);
      background:rgba(255,255,255,0.05);
      backdrop-filter:blur(20px);
      border:1px solid rgba(0,212,255,0.3);
      border-radius:32px;
      padding:48px;
      box-shadow:0 24px 80px rgba(0,0,0,0.5);
      animation:slideUp 0.5s cubic-bezier(0.4,0,0.2,1);
    }
    
    @keyframes slideUp{
      from{opacity:0;transform:translateY(40px)}
      to{opacity:1;transform:translateY(0)}
    }
    
    .login-title{
      font-size:32px;
      font-weight:900;
      font-family:'Space Grotesk',sans-serif;
      background:linear-gradient(135deg,var(--primary),var(--secondary));
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      background-clip:text;
      margin-bottom:12px;
    }
    
    .login-subtitle{
      color:var(--muted);
      margin-bottom:32px;
      font-size:15px;
    }
    
    .login-field{
      margin-bottom:24px;
    }
    
    .login-label{
      display:block;
      font-size:13px;
      font-weight:600;
      color:var(--muted);
      margin-bottom:8px;
      text-transform:uppercase;
      letter-spacing:1px;
    }
    
    .login-input{
      width:100%;
      padding:16px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,0.1);
      background:rgba(255,255,255,0.05);
      color:white;
      font-size:15px;
      transition:all 0.3s;
      outline:none;
    }
    
    .login-input:focus{
      border-color:var(--primary);
      background:rgba(0,212,255,0.1);
      box-shadow:0 0 0 3px rgba(0,212,255,0.1);
    }
    
    .login-error{
      color:var(--danger);
      font-size:13px;
      font-weight:600;
      margin-top:16px;
      min-height:20px;
    }
    
    @media (max-width:1200px){
      .kpi-section{grid-template-columns:1fr}
      .kpi-hero{margin:0 auto}
      .span-4,.span-6,.span-8,.span-12{grid-column:span 12}
    }
    
    @media (max-width:768px){
      .bar{padding:16px 24px}
      .main{padding:24px}
      .filters{grid-template-columns:1fr}
      .map-container{height:500px}
      .map-stats,.map-legend{position:relative;top:auto;right:auto;bottom:auto;left:auto;margin-top:16px}
    }
  </style>
</head>
<body>
<div class="app">
  <header>
    <div class="bar">
      <div class="logo">
        <span>Coromandel CPC Analytics</span>
      </div>
      <div class="header-actions">
        <button class="btn" id="downloadBtn">📥 Export Data</button>
        <button class="btn btn-logout" id="logoutBtn">🚪 Logout</button>
      </div>
    </div>
  </header>

  <main class="main">
    <!-- Filters -->
    <div class="glass-card">
      <div class="filters">
        <div class="filter-group">
          <label class="filter-label">📅 Date Range</label>
          <input id="dateRange" class="filter-input" placeholder="Select date range" />
        </div>
        
        <div class="filter-group" style="display:none">
          <input id="dateFrom" type="date" />
          <input id="dateTo" type="date" />
        </div>

        <div class="filter-group">
          <label class="filter-label">🌍 State</label>
          <select id="state" class="filter-select"></select>
        </div>

        <div class="filter-group">
          <label class="filter-label">📍 District</label>
          <select id="district" class="filter-select"></select>
        </div>

        <div class="filter-group">
          <label class="filter-label">🏪 Retailer</label>
          <select id="retailer" class="filter-select"></select>
        </div>

        <div class="filter-group">
          <label class="filter-label">📦 Product</label>
          <select id="product" class="filter-select"></select>
        </div>

        <div class="filter-group">
          <label class="filter-label">📏 Unit</label>
          <select id="unit" class="filter-select"></select>
        </div>

        <div class="filter-group">
          <label class="filter-label">🔢 Min Qty</label>
          <input id="qtyMin" class="filter-input" type="number" min="0" placeholder="0" />
        </div>

        <div class="filter-group">
          <label class="filter-label">✅ Status</label>
          <select id="status" class="filter-select"></select>
        </div>

        <div class="filter-group">
          <button class="btn" id="resetBtn" style="width:100%">🔄 Reset All</button>
        </div>
      </div>
    </div>

    <!-- KPIs -->
    <div class="glass-card">
      <h2 class="card-title">📊 Performance Overview</h2>
      <div class="kpi-section">
        <div class="kpi-hero">
          <div class="kpi-hero-label">Total Scans</div>
          <div class="kpi-hero-value" id="kpiTotal">0</div>
        </div>
        <div class="kpi-grid">
          <div class="kpi-card">
            <div class="kpi-label">✅ Approved</div>
            <div class="kpi-value" id="kpiApproved">0</div>
            <div class="kpi-subtitle" id="kpiApprovedPct">0%</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-label">❌ Rejected</div>
            <div class="kpi-value" id="kpiRejected">0</div>
            <div class="kpi-subtitle" id="kpiRejectedPct">0%</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-label">⏳ Pending</div>
            <div class="kpi-value" id="kpiPending">0</div>
            <div class="kpi-subtitle" id="kpiPendingPct">0%</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-label">👨‍🌾 Farmers</div>
            <div class="kpi-value" id="kpiFarmers">0</div>
            <div class="kpi-subtitle" id="kpiFarmersUnique">Unique: 0</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-label">🏪 Retailers</div>
            <div class="kpi-value" id="kpiRetailers">0</div>
            <div class="kpi-subtitle" id="kpiRetailersTotal">of 0</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Charts Grid -->
    <div class="content-grid">
      <div class="glass-card span-4">
        <h3 class="card-title">📈 Approval Status</h3>
        <canvas id="statusChart" height="280"></canvas>
      </div>

      <div class="glass-card span-8">
        <h3 class="card-title">📅 Daily Trend</h3>
        <canvas id="trendChart" height="280"></canvas>
      </div>

      <div class="glass-card span-6">
        <h3 class="card-title">🌍 Top States</h3>
        <div class="states-table" id="statesTable"></div>
      </div>

      <div class="glass-card span-6">
        <h3 class="card-title">🏪 Retailer Performance</h3>
        <canvas id="retailerChart" height="240"></canvas>
      </div>

      <div class="glass-card span-6">
        <h3 class="card-title">📍 District Analysis</h3>
        <canvas id="districtChart" height="200"></canvas>
      </div>

      <div class="glass-card span-6">
        <h3 class="card-title">📦 Product Mix</h3>
        <canvas id="productChart" height="200"></canvas>
      </div>

      <!-- India Map - Smart Professional -->
      <div class="glass-card span-12">
        <h3 class="card-title">🗺️ Geographic Distribution</h3>
        <div class="map-container">
          <div id="indiaMap"></div>
          
          <!-- Map Stats Panel -->
          <div class="map-stats">
            <div class="map-stats-title">Live Statistics</div>
            <div class="map-stat-item">
              <span class="map-stat-label">Active States</span>
              <span class="map-stat-value stat-primary" id="mapActiveStates">0</span>
            </div>
            <div class="map-stat-item">
              <span class="map-stat-label">Approved</span>
              <span class="map-stat-value stat-success" id="mapApproved">0</span>
            </div>
            <div class="map-stat-item">
              <span class="map-stat-label">Pending</span>
              <span class="map-stat-value stat-warning" id="mapPending">0</span>
            </div>
            <div class="map-stat-item">
              <span class="map-stat-label">Rejected</span>
              <span class="map-stat-value stat-danger" id="mapRejected">0</span>
            </div>
          </div>

          <!-- Legend -->
          <div class="map-legend">
            <div class="legend-title">Approval Tiers</div>
            <div class="legend-item">
              <div class="legend-color" style="background:#00e676"></div>
              <span>Elite (1000+)</span>
            </div>
            <div class="legend-item">
              <div class="legend-color" style="background:#00e5ff"></div>
              <span>High (500-999)</span>
            </div>
            <div class="legend-item">
              <div class="legend-color" style="background:#ffc107"></div>
              <span>Medium (250-499)</span>
            </div>
            <div class="legend-item">
              <div class="legend-color" style="background:#ff9800"></div>
              <span>Growing (100-249)</span>
            </div>
            <div class="legend-item">
              <div class="legend-color" style="background:#ff5252"></div>
              <span>Emerging (1-99)</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <div class="footer">
    ⚡ Powered by Coromandel CPC Analytics Engine • Real-time Campaign Intelligence
  </div>
</div>

<!-- Login -->
<div class="overlay" id="loginOverlay">
  <form class="login-card" id="loginForm">
    <h2 class="login-title">🔐 Secure Access</h2>
    <p class="login-subtitle">Enter your credentials to access the analytics hub</p>
    <div class="login-field">
      <label class="login-label">Username</label>
      <input id="username" class="login-input" autocomplete="username" placeholder="Enter username" />
    </div>
    <div class="login-field">
      <label class="login-label">Password</label>
      <input id="password" class="login-input" type="password" autocomplete="current-password" placeholder="Enter password" />
    </div>
    <button class="btn" type="submit" style="width:100%">Login to Dashboard</button>
    <div class="login-error" id="loginError"></div>
  </form>
</div>

<script>
  const CSV_URL = './data.csv';
  const VALID_USER = 'digicides';
  const VALID_PASS = 'coro@cpc';
  const LS_KEY = 'cpc_login_ok';

  // Login
  const overlay = document.getElementById('loginOverlay');
  const loginForm = document.getElementById('loginForm');
  const loginError = document.getElementById('loginError');

  function unlock(){ overlay.style.display='none'; }
  if(localStorage.getItem(LS_KEY)==='1'){ unlock(); }

  loginForm.addEventListener('submit', (e)=>{
    e.preventDefault();
    const u = document.getElementById('username').value.trim();
    const p = document.getElementById('password').value;
    if(u===VALID_USER && p===VALID_PASS){
      localStorage.setItem(LS_KEY,'1');
      unlock();
    } else {
      loginError.textContent = '❌ Invalid credentials. Please try again.';
    }
  });

  document.getElementById('logoutBtn').addEventListener('click', ()=>{
    if(confirm('Are you sure you want to logout?')){
      localStorage.removeItem(LS_KEY);
      location.reload();
    }
  });

  // Utilities
  const trim = (s)=> (s==null?'' : String(s).trim());
  const toDateKey = (dt)=>{
    if(!dt) return '';
    const d = new Date(dt.replace(/-/g,'/'));
    if(isNaN(d)) return '';
    return d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0');
  };
  function uniqSorted(arr){ return [...new Set(arr.filter(Boolean))].sort((a,b)=>a.localeCompare(b)); }

  function parseProducts(cartStr){
    const map = new Map();
    const s = trim(cartStr);
    if(!s) return map;
    const parts = s.split(',');
    for(const raw of parts){
      const item = raw.trim();
      const m = item.match(/^(.+?)\s*-\s*qty\s*(\d+)/i) || item.match(/^(.+?)\s*$/);
      if(m){
        const name = trim(m[1]).replace(/\s{2,}/g,' ');
        const q = m[2] ? Number(m[2]) : 1;
        map.set(name, (map.get(name)||0)+ (isFinite(q)? q : 1));
      }
    }
    return map;
  }

  function parseCartItems(cartStr){
    const s = trim(cartStr);
    if(!s) return [];
    const parts = s.split(',');
    const items = [];
    for(const raw of parts){
      const t = raw.trim();
      const m = t.match(/^(.+?)\s*-\s*qty\s*(\d+)(?:\s*-\s*(.+))?$/i);
      if(m){
        items.push({ name: trim(m[1]), qty: Number(m[2])||1, unit: m[3]?trim(m[3]):'' });
      } else {
        items.push({ name: t, qty: 1, unit: '' });
      }
    }
    return items;
  }

  // State
  let RAW = [];
  let FILTERS = { dateFrom:'', dateTo:'', state:'', district:'', retailer:'', product:'', unit:'', qtyMin:0, status:'' };

  // DOM
  const selDateFrom = document.getElementById('dateFrom');
  const selDateTo = document.getElementById('dateTo');
  const selDateRange = document.getElementById('dateRange');
  const selState = document.getElementById('state');
  const selDistrict = document.getElementById('district');
  const selRetailer = document.getElementById('retailer');
  const selProduct = document.getElementById('product');
  const selUnit = document.getElementById('unit');
  const inpQtyMin = document.getElementById('qtyMin');
  const selStatus = document.getElementById('status');

  flatpickr("#dateRange",{
    mode:"range",
    dateFormat:"Y-m-d",
    onChange:(dates)=>{
      if(dates.length===2){
        FILTERS.dateFrom = dates[0].toISOString().slice(0,10);
        FILTERS.dateTo   = dates[1].toISOString().slice(0,10);
        selDateFrom.value = FILTERS.dateFrom;
        selDateTo.value   = FILTERS.dateTo;
        render();
      }
    }
  });

  document.getElementById('resetBtn').addEventListener('click', ()=>{
    FILTERS = { dateFrom:'', dateTo:'', state:'', district:'', retailer:'', product:'', unit:'', qtyMin:0, status:'' };
    selDateFrom.value = selDateTo.value = '';
    selDateRange._flatpickr && selDateRange._flatpickr.clear();
    selState.value = selDistrict.value = selRetailer.value = selProduct.value = selUnit.value = selStatus.value = '';
    inpQtyMin.value = '';
    populateFilters(RAW);
    render();
  });

  document.getElementById('downloadBtn').addEventListener('click', ()=>{
    const filtered = applyFilters(RAW);
    if(filtered.length === 0){ alert('No data to download!'); return; }
    const csv = Papa.unparse(filtered);
    const blob = new Blob([csv], {type:'text/csv'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'cpc_export_' + new Date().toISOString().slice(0,10) + '.csv';
    a.click();
    URL.revokeObjectURL(url);
  });

  // Charts
  const charts = {};
  function makeChart(id, type, data, opts){
    const ctx = document.getElementById(id).getContext('2d');
    if(charts[id]){ 
      charts[id].data = data; 
      charts[id].options = opts; 
      charts[id].update(); 
      return charts[id]; 
    }
    charts[id] = new Chart(ctx, { type, data, options: opts });
    return charts[id];
  }

  const chartColors = ['#00d4ff','#ff6b9d','#7c3aed','#00e676','#ffc107','#ff5252','#00e5ff','#ff9800'];
  function palette(n){
    const arr = []; for(let i=0;i<n;i++) arr.push(chartColors[i%chartColors.length]);
    return arr;
  }

  function applyFilters(rows){
    const f = FILTERS;
    return rows.filter(r=>{
      if(f.dateFrom || f.dateTo){
        const scanDate = toDateKey(trim(r['Scan Date']));
        if(f.dateFrom && scanDate < f.dateFrom) return false;
        if(f.dateTo && scanDate > f.dateTo) return false;
      }
      if(f.state && trim(r.State)!==f.state) return false;
      if(f.district && trim(r.District)!==f.district) return false;
      if(f.retailer && trim(r['Retailer Name'])!==f.retailer) return false;
      if(f.status && trim((r['Submission Status']||'').toLowerCase())!==f.status.toLowerCase()) return false;

      if(f.product || (f.qtyMin||0)>0){
        const m = parseProducts(r['Cart Items']);
        if(f.product){
          if(!m.has(f.product)) return false;
          if((f.qtyMin||0)>0 && (m.get(f.product)||0) < f.qtyMin) return false;
        } else if((f.qtyMin||0)>0){
          let ok=false; for(const v of m.values()){ if(v>=f.qtyMin){ ok=true; break; } }
          if(!ok) return false;
        }
      }

      if(f.unit){
        const items = parseCartItems(r['Cart Items']);
        const has = items.some(it=>{
          if(f.product) return it.name===f.product && it.unit===f.unit;
          return it.unit===f.unit;
        });
        if(!has) return false;
      }

      return true;
    });
  }

  function updateKpis(rows){
    const total = rows.length;
    const yes = rows.filter(r=>/^yes$/i.test(trim(r['Submission Status']))).length;
    const pending = rows.filter(r=>/^pending$/i.test(trim(r['Submission Status']))).length;
    const no = rows.filter(r=>/^no$/i.test(trim(r['Submission Status']))).length;

    const allPhones = rows.map(r=>trim(r['Phone Number'])).filter(p=>p);
    const uniquePhones = new Set(allPhones);

    const activeRINs = new Set(rows.map(r=>trim(r['RIN'])).filter(rin=>rin));
    const activeRetailers = activeRINs.size;

    const STATE_RETAILER_TOTALS = {
      'West Bengal': 183,
      'Maharashtra': 616,
      'Telangana': 161,
      'Andhra Pradesh': 307,
      'Karnataka': 636
    };

    let totalRetailers = 1903;
    if(FILTERS.state){
      totalRetailers = STATE_RETAILER_TOTALS[FILTERS.state] || 0;
      if(totalRetailers === 0){
        const stateRetailers = RAW.filter(r=>trim(r.State)===FILTERS.state);
        const stateRetailerRINs = new Set(stateRetailers.map(r=>trim(r['RIN'])).filter(rin=>rin));
        totalRetailers = stateRetailerRINs.size;
      }
    }

    document.getElementById('kpiTotal').textContent = total.toLocaleString();
    document.getElementById('kpiApproved').textContent = yes.toLocaleString();
    document.getElementById('kpiRejected').textContent = no.toLocaleString();
    document.getElementById('kpiPending').textContent = pending.toLocaleString();
    document.getElementById('kpiFarmers').textContent = allPhones.length.toLocaleString();
    document.getElementById('kpiFarmersUnique').textContent = `Unique: ${uniquePhones.size.toLocaleString()}`;
    document.getElementById('kpiRetailers').textContent = activeRetailers.toLocaleString();
    document.getElementById('kpiRetailersTotal').textContent = `of ${totalRetailers.toLocaleString()}`;

    const yesPct = total > 0 ? ((yes / total) * 100).toFixed(1) : '0.0';
    const noPct = total > 0 ? ((no / total) * 100).toFixed(1) : '0.0';
    const pendingPct = total > 0 ? ((pending / total) * 100).toFixed(1) : '0.0';

    document.getElementById('kpiApprovedPct').textContent = `${yesPct}% of total`;
    document.getElementById('kpiRejectedPct').textContent = `${noPct}% of total`;
    document.getElementById('kpiPendingPct').textContent = `${pendingPct}% of total`;
  }

  function buildCounts(rows, key){
    const m = new Map();
    for(const r of rows){
      const k = trim(r[key]); if(!k) continue;
      m.set(k, (m.get(k)||0)+1);
    }
    return [...m.entries()].sort((a,b)=>b[1]-a[1]);
  }

  function renderStatesTable(rows){
    const states = buildCounts(rows, 'State').slice(0, 10);
    let html = '';
    states.forEach((s, i)=>{
      const bar = Math.round((s[1] / (states[0][1] || 1)) * 100);
      const gradients = [
        'linear-gradient(135deg,#00d4ff,#7c3aed)',
        'linear-gradient(135deg,#ff6b9d,#ff5252)',
        'linear-gradient(135deg,#00e676,#00e5ff)',
        'linear-gradient(135deg,#ffc107,#ff9800)',
        'linear-gradient(135deg,#7c3aed,#ff6b9d)'
      ];
      const grad = gradients[i % gradients.length];
      html += `<div class="state-row">
        <div class="state-info">
          <div class="state-rank">${i+1}</div>
          <div class="state-name-text">${s[0]}</div>
        </div>
        <div class="state-value">${s[1].toLocaleString()}</div>
      </div>
      <div class="state-bar">
        <div class="state-bar-fill" style="width:${bar}%;background:${grad}"></div>
      </div>`;
    });
    document.getElementById('statesTable').innerHTML = html;
  }

  function renderCharts(rows){
    const sYes = rows.filter(r=>/^yes$/i.test(trim(r['Submission Status']))).length;
    const sNo = rows.filter(r=>/^no$/i.test(trim(r['Submission Status']))).length;
    const sPending = rows.filter(r=>/^pending$/i.test(trim(r['Submission Status']))).length;
    
    makeChart('statusChart','doughnut',{
      labels:['Approved','Rejected','Pending'],
      datasets:[{ 
        data:[sYes,sNo,sPending], 
        backgroundColor:['#00e676','#ff5252','#ffc107'], 
        borderWidth: 0,
        hoverOffset: 10
      }]
    },{
      plugins:{ 
        legend:{ 
          display: true,
          position: 'bottom',
          labels:{ 
            color: '#ffffff', 
            padding: 20, 
            font:{ size: 13, weight: '700' },
            usePointStyle: true
          } 
        }
      },
      cutout:'70%'
    });

    const trendMap = new Map();
    for(const r of rows){ const k = toDateKey(trim(r['Scan Date'])); if(k) trendMap.set(k,(trendMap.get(k)||0)+1); }
    const trend = [...trendMap.entries()].sort((a,b)=>a[0].localeCompare(b[0]));
    makeChart('trendChart','line',{
      labels: trend.map(x=>x[0]),
      datasets:[{ 
        data: trend.map(x=>x[1]), 
        borderColor:'#00d4ff',
        backgroundColor:'rgba(0,212,255,0.1)',
        borderWidth:3, 
        tension:.4,
        fill:true,
        pointRadius:0,
        pointHoverRadius:6,
        pointBackgroundColor:'#00d4ff',
        pointBorderColor:'#fff',
        pointBorderWidth:2
      }]
    },{ 
      scales:{ 
        x:{ ticks:{ color:'#94a3b8', font:{size:11} }, grid:{color:'rgba(255,255,255,0.05)'} }, 
        y:{ ticks:{ color:'#94a3b8', font:{size:11} }, grid:{ color:'rgba(255,255,255,0.05)' } } 
      }, 
      plugins:{ legend:{ display:false } } 
    });

    const retailers = buildCounts(rows,'Retailer Name').slice(0,8);
    const retailerApproved = retailers.map(r => rows.filter(row => trim(row['Retailer Name']) === r[0] && /^yes$/i.test(trim(row['Submission Status']))).length);
    const retailerPending  = retailers.map(r => rows.filter(row => trim(row['Retailer Name']) === r[0] && /^pending$/i.test(trim(row['Submission Status']))).length);
    const retailerRejected = retailers.map(r => rows.filter(row => trim(row['Retailer Name']) === r[0] && /^no$/i.test(trim(row['Submission Status']))).length);
    
    makeChart('retailerChart','bar',{
      labels: retailers.map(x=>x[0]),
      datasets:[
        { label: 'Approved', data: retailerApproved, backgroundColor: '#00e676', borderRadius: 8 },
        { label: 'Pending',  data: retailerPending,  backgroundColor: '#ffc107', borderRadius: 8 },
        { label: 'Rejected', data: retailerRejected, backgroundColor: '#ff5252', borderRadius: 8 }
      ]
    },{ 
      plugins: { legend: { display: true, position: 'top', labels: { color: '#ffffff', font:{size:12,weight:'600'}, usePointStyle:true } } }, 
      scales: { 
        x: { ticks: { color: '#94a3b8', maxRotation: 45, font:{size:10} }, grid: { display: false } }, 
        y: { ticks: { color: '#94a3b8' }, grid: { color: 'rgba(255,255,255,0.05)' } } 
      } 
    });

    const districts = buildCounts(rows,'District').slice(0,10);
    makeChart('districtChart','bar',{
      labels: districts.map(x=>x[0]),
      datasets:[{ 
        data: districts.map(x=>x[1]), 
        backgroundColor: palette(districts.length), 
        borderWidth:0, 
        borderRadius:8 
      }]
    },{ 
      indexAxis:'y', 
      plugins:{ legend:{ display:false } }, 
      scales:{ 
        x:{ ticks:{ color:'#94a3b8' }, grid:{color:'rgba(255,255,255,0.05)'} }, 
        y:{ ticks:{ color:'#ffffff',font:{size:11,weight:'600'} }, grid:{display:false} } 
      } 
    });

    const pMap = new Map();
    for(const r of rows){
      const m = parseProducts(r['Cart Items']);
      for(const [name,qty] of m){ pMap.set(name,(pMap.get(name)||0)+qty); }
    }
    const pArr = [...pMap.entries()].sort((a,b)=>b[1]-a[1]).slice(0,12);
    makeChart('productChart','bar',{
      labels: pArr.map(x=>x[0]),
      datasets:[{ 
        data: pArr.map(x=>x[1]), 
        backgroundColor: palette(pArr.length), 
        borderWidth:0, 
        borderRadius:10 
      }]
    },{ 
      plugins:{ legend:{ display:false } }, 
      scales:{ 
        x:{ ticks:{ color:'#ffffff', maxRotation:45, font:{size:10,weight:'600'} }, grid:{display:false} }, 
        y:{ ticks:{ color:'#94a3b8' }, grid:{color:'rgba(255,255,255,0.05)'} } 
      } 
    });
  }

  // India Map
  let indiaMap = null;
  let mapLayer = null;

  const stateCoordinates = {
    'Andhra Pradesh': [15.9129, 79.7400],
    'Arunachal Pradesh': [28.2180, 94.7278],
    'Assam': [26.2006, 92.9376],
    'Bihar': [25.0961, 85.3131],
    'Chhattisgarh': [21.2787, 81.8661],
    'Goa': [15.2993, 74.1240],
    'Gujarat': [22.2587, 71.1924],
    'Haryana': [29.0588, 76.0856],
    'Himachal Pradesh': [31.1048, 77.1734],
    'Jharkhand': [23.6102, 85.2799],
    'Karnataka': [15.3173, 75.7139],
    'Kerala': [10.8505, 76.2711],
    'Madhya Pradesh': [22.9734, 78.6569],
    'Maharashtra': [19.7515, 75.7139],
    'Manipur': [24.6637, 93.9063],
    'Meghalaya': [25.4670, 91.3662],
    'Mizoram': [23.1645, 92.9376],
    'Nagaland': [26.1584, 94.5624],
    'Odisha': [20.9517, 85.0985],
    'Punjab': [31.1471, 75.3412],
    'Rajasthan': [27.0238, 74.2179],
    'Sikkim': [27.5330, 88.5122],
    'Tamil Nadu': [11.1271, 78.6569],
    'Telangana': [18.1124, 79.0193],
    'Tripura': [23.9408, 91.9882],
    'Uttar Pradesh': [26.8467, 80.9462],
    'Uttarakhand': [30.0668, 79.0193],
    'West Bengal': [22.9868, 87.8550],
    'Andaman and Nicobar Islands': [11.7401, 92.6586],
    'Chandigarh': [30.7333, 76.7794],
    'Dadra and Nagar Haveli': [20.1809, 73.0169],
    'Daman and Diu': [20.4283, 72.8397],
    'Lakshadweep': [10.5667, 72.6417],
    'Delhi': [28.7041, 77.1025],
    'Puducherry': [11.9416, 79.8083],
    'Jammu and Kashmir': [33.7782, 76.5762],
    'Ladakh': [34.1526, 77.5771]
  };

  function getMarkerLevel(approved) {
    if (approved >= 1000) return 1;
    if (approved >= 500) return 2;
    if (approved >= 250) return 3;
    if (approved >= 100) return 4;
    return 5;
  }

  function getMarkerIcon(state, approved) {
    const level = getMarkerLevel(approved);
    const shortName = state.length > 12 ? state.substring(0, 10) + '...' : state;
    
    return L.divIcon({
      className: 'state-marker',
      html: `
        <div class="state-marker marker-level-${level}">
          <div class="state-name">${shortName}</div>
          <div class="state-count">
            <span>✓</span>
            <span>${approved.toLocaleString()}</span>
          </div>
        </div>
      `,
      iconSize: [null, null],
      iconAnchor: [50, 40]
    });
  }

  function initMap() {
    if (indiaMap) return;
    indiaMap = L.map('indiaMap', { center: [22.5, 82.5], zoom: 5, minZoom: 4, maxZoom: 8, zoomControl: true });
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { 
      attribution: '© OpenStreetMap, © CartoDB',
      maxZoom: 19 
    }).addTo(indiaMap);
  }

  function renderIndiaMap(rows) {
    if (!indiaMap) { initMap(); }
    if (mapLayer) { indiaMap.removeLayer(mapLayer); }

    const stateData = new Map();
    for (const r of rows) {
      const st = trim(r.State);
      if (!st) continue;
      if (!stateData.has(st)) stateData.set(st, { total: 0, approved: 0, rejected: 0, pending: 0 });
      const data = stateData.get(st);
      data.total++;
      const status = trim(r['Submission Status']).toLowerCase();
      if (status === 'yes') data.approved++;
      else if (status === 'no') data.rejected++;
      else if (status === 'pending') data.pending++;
    }
    
    mapLayer = L.layerGroup();
    let totalApproved = 0, totalPending = 0, totalRejected = 0;

    for (const [state, coords] of Object.entries(stateCoordinates)) {
      const data = stateData.get(state);
      if (!data || data.approved === 0) continue;

      totalApproved += data.approved;
      totalPending += data.pending;
      totalRejected += data.rejected;

      const approvalRate = ((data.approved / data.total) * 100).toFixed(1);
      const marker = L.marker(coords, { icon: getMarkerIcon(state, data.approved) });

      const popupContent = `
        <div class="popup-state">📍 ${state}</div>
        <div class="popup-row">
          <span class="popup-label">✅ Approved</span>
          <span class="popup-value stat-success">${data.approved.toLocaleString()}</span>
        </div>
        <div class="popup-row">
          <span class="popup-label">⏳ Pending</span>
          <span class="popup-value stat-warning">${data.pending.toLocaleString()}</span>
        </div>
        <div class="popup-row">
          <span class="popup-label">❌ Rejected</span>
          <span class="popup-value stat-danger">${data.rejected.toLocaleString()}</span>
        </div>
        <div class="popup-row" style="border-top:2px solid rgba(255,255,255,0.1);margin-top:12px;padding-top:12px">
          <span class="popup-label">📊 Total</span>
          <span class="popup-value">${data.total.toLocaleString()}</span>
        </div>
        <div class="popup-row">
          <span class="popup-label">🎯 Rate</span>
          <span class="popup-value stat-success">${approvalRate}%</span>
        </div>
      `;

      marker.bindPopup(popupContent, { closeButton: true, maxWidth: 360 });
      marker.on('click', () => { FILTERS.state = state; selState.value = state; render(); });
      marker.addTo(mapLayer);
    }

    mapLayer.addTo(indiaMap);
    
    // Update map stats
    document.getElementById('mapActiveStates').textContent = stateData.size;
    document.getElementById('mapApproved').textContent = totalApproved.toLocaleString();
    document.getElementById('mapPending').textContent = totalPending.toLocaleString();
    document.getElementById('mapRejected').textContent = totalRejected.toLocaleString();

    setTimeout(() => { indiaMap.fitBounds([[8, 68],[37, 97]]); }, 100);
  }

  function populateFilters(rows){
    const states = uniqSorted(rows.map(r=>trim(r.State)));
    const dists  = uniqSorted(rows.map(r=>trim(r.District)));
    const rets   = uniqSorted(rows.map(r=>trim(r['Retailer Name'])));
    const products = uniqSorted(rows.flatMap(r=>[...parseProducts(r['Cart Items']).keys()]));
    const unitsAll = uniqSorted(rows.flatMap(r=>parseCartItems(r['Cart Items']).map(it=>it.unit).filter(Boolean)));
    const statuses = ['','Yes','No','Pending'];

    function fill(sel, items){ 
      sel.innerHTML = ''; 
      const opt0 = document.createElement('option'); 
      opt0.value=''; opt0.textContent='All'; sel.appendChild(opt0); 
      for(const v of items){ const o=document.createElement('option'); o.value=v; o.textContent=v; sel.appendChild(o); }
    }

    fill(selState, states); 
    fill(selDistrict, dists); 
    fill(selRetailer, rets); 
    fill(selProduct, products);
    fill(selUnit, unitsAll);
    fill(selStatus, statuses);
  }

  function attachFilterHandlers(){
    selDateFrom.onchange = ()=>{ FILTERS.dateFrom = selDateFrom.value; render(); };
    selDateTo.onchange   = ()=>{ FILTERS.dateTo   = selDateTo.value; render(); };

    selState.onchange = ()=>{
      FILTERS.state = selState.value;

      const dists = uniqSorted(RAW.filter(r=>!FILTERS.state || trim(r.State)===FILTERS.state).map(r=>trim(r.District)));
      selDistrict.innerHTML = ''; 
      const opt0=document.createElement('option'); opt0.value=''; opt0.textContent='All'; selDistrict.appendChild(opt0);
      for(const v of dists){ const o=document.createElement('option'); o.value=v; o.textContent=v; selDistrict.appendChild(o); }
      FILTERS.district = ''; selDistrict.value='';

      const rets = uniqSorted(RAW.filter(r=>!FILTERS.state || trim(r.State)===FILTERS.state).map(r=>trim(r['Retailer Name'])));
      selRetailer.innerHTML = ''; 
      const optR=document.createElement('option'); optR.value=''; optR.textContent='All'; selRetailer.appendChild(optR);
      for(const v of rets){ const o=document.createElement('option'); o.value=v; o.textContent=v; selRetailer.appendChild(o); }
      FILTERS.retailer = ''; selRetailer.value='';

      render();
    };

    selDistrict.onchange = ()=>{
      FILTERS.district = selDistrict.value;

      const rets = uniqSorted(RAW.filter(r=>{
        if(FILTERS.state && trim(r.State)!==FILTERS.state) return false;
        if(FILTERS.district && trim(r.District)!==FILTERS.district) return false;
        return true;
      }).map(r=>trim(r['Retailer Name'])));
      selRetailer.innerHTML = ''; 
      const optR=document.createElement('option'); optR.value=''; optR.textContent='All'; selRetailer.appendChild(optR);
      for(const v of rets){ const o=document.createElement('option'); o.value=v; o.textContent=v; selRetailer.appendChild(o); }
      FILTERS.retailer = ''; selRetailer.value='';

      render();
    };

    selRetailer.onchange = ()=>{ FILTERS.retailer = selRetailer.value; render(); };

    selProduct.onchange = ()=>{
      FILTERS.product = selProduct.value;

      const unitsSet = new Set();
      RAW.forEach(r=>{
        parseCartItems(r['Cart Items']).forEach(it=>{
          if(!FILTERS.product || it.name===FILTERS.product){
            if(it.unit) unitsSet.add(it.unit);
          }
        });
      });
      const units = [...unitsSet].sort((a,b)=>a.localeCompare(b));
      selUnit.innerHTML = '';
      const optU=document.createElement('option'); optU.value=''; optU.textContent='All'; selUnit.appendChild(optU);
      for(const v of units){ const o=document.createElement('option'); o.value=v; o.textContent=v; selUnit.appendChild(o); }
      FILTERS.unit = ''; selUnit.value='';

      render();
    };

    selUnit.onchange = ()=>{ FILTERS.unit = selUnit.value; render(); };
    selStatus.onchange = ()=>{ FILTERS.status = selStatus.value; render(); };

    let to=null; 
    inpQtyMin.oninput = ()=>{ 
      clearTimeout(to); 
      to=setTimeout(()=>{ FILTERS.qtyMin = Number(inpQtyMin.value||0); render(); }, 300); 
    };
  }

  function render(){
    const rows = applyFilters(RAW);
    updateKpis(rows);
    renderStatesTable(rows);
    renderIndiaMap(rows);
    requestAnimationFrame(()=> renderCharts(rows));
  }

  function normalizeRow(r){
    return {
      'User ID': r['User ID']||r['UserID']||r['id']||'',
      'Phone Number': r['Phone Number']||r['Phone']||r['phone']||'',
      'First Name': r['First Name']||r['FirstName']||'',
      'Last Name': r['Last Name']||r['LastName']||'',
      'District': r['District']||'',
      'State': r['State']||'',
      'Language': r['Language']||'',
      'Pin Code': r['Pin Code']||r['Pincode']||'',
      'QR Code': r['QR Code']||'',
      'Land Acreage': r['Land Acreage']||r['Land']||'',
      'Crop Name': r['Crop Name']||'',
      'Scan Date': r['Scan Date']||r['Date']||'',
      'RIN': r['RIN']||'',
      'Retailer Name': r['Retailer Name']||r['Retailer']||'',
      'Cart Items': r['Cart Items']||'',
      'Coupon Code': r['Coupon Code']||'',
      'Submission Status': r['Submission Status']||r['Approved Status']||''
    };
  }

  Papa.parse(CSV_URL, {
    download: true,
    header: true,
    skipEmptyLines: true,
    dynamicTyping: false,
    complete: (res)=>{
      RAW = res.data.map(normalizeRow);
      populateFilters(RAW);
      attachFilterHandlers();
      render();
    },
    error: (err)=>{
      console.error('CSV load error', err);
      alert('Failed to load data.csv');
    }
  });
</script>
</body>
</html>
